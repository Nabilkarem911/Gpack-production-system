<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.PACK - إدارة الموردين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .gpack-purple { background-color: #3e206d; }
        .gpack-yellow { color: #fccf4d; }
        .gpack-btn { background-color: #fccf4d; color: #3e206d; transition: all 0.3s; }
        .gpack-btn:hover { background-color: #e6bd45; transform: translateY(-2px); }
        .sidebar-item:hover { background-color: rgba(255,255,255,0.1); border-right: 4px solid #fccf4d; }
        .sidebar-item.active { background-color: rgba(255,255,255,0.15); border-right: 4px solid #fccf4d; color: #fff; }
        
        /* Modal Transitions */
        .modal { transition: opacity 0.2s ease-in-out; }
        body.modal-active { overflow: hidden; }
        
        /* Helpers */
        .tab-btn { border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; padding: 10px 15px; white-space: nowrap; }
        .tab-btn.active { border-bottom-color: #3e206d; color: #3e206d; font-weight: bold; background-color: #f9fafb; }
        .supply-tag { background-color: #ede9fe; color: #5b21b6; border-color: #ddd6fe; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 2px; display: inline-block; }
        .input-std { width: 100%; border: 1px solid #d1d5db; padding: 8px; border-radius: 6px; font-size: 0.875rem; outline: none; transition: border-color 0.2s; }
        .input-std:focus { border-color: #3e206d; box-shadow: 0 0 0 1px #3e206d; }
        
        /* Serial Number LTR Force */
        .serial-num { direction: ltr; unicode-bidi: embed; display: inline-block; text-align: left; }

        /* Sidebar Transition */
        #sidebar { transition: width 0.3s ease, transform 0.3s ease; }
        .sidebar-collapsed { width: 0 !important; overflow: hidden; }
        @media (max-width: 768px) {
            .sidebar-mobile-hidden { transform: translateX(100%); }
            .sidebar-collapsed { width: 16rem !important; }
        }

        /* Hiding scrollbars for nice UI */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- PRINT STYLES --- */
        @media print {
            body * { visibility: hidden; }
            #printableInvoice, #printableInvoice * { visibility: visible; }
            #printableInvoice { 
                position: absolute; left: 0; top: 0; width: 100%; min-height: 100%; 
                background: white; z-index: 99999; padding: 0; display: block !important; 
            }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        .print-header { background-color: #3e206d; color: white; padding: 20px; border-bottom: 4px solid #fccf4d; }
        .print-table th { background-color: #3e206d !important; color: white !important; padding: 8px; font-size: 12px; border: 1px solid #3e206d; }
        .print-table td { padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; border: 1px solid #eee; text-align: center;}
        .print-row-even { background-color: #f9fafb; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-gray-100">

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <aside id="sidebar" class="w-64 gpack-purple text-white flex flex-col shadow-2xl z-30 fixed md:relative h-full sidebar-mobile-hidden md:transform-none shrink-0">
        <div class="h-20 flex items-center justify-between px-6 border-b border-purple-800/50">
            <h1 class="text-2xl font-bold tracking-wider flex items-center gap-2">
                <i class="fas fa-box-open gpack-yellow"></i> <span class="whitespace-nowrap">G.PACK</span>
            </h1>
            <button onclick="toggleSidebar()" class="md:hidden text-white hover:text-red-300"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="p-4 flex items-center gap-3 border-b border-purple-800/50 bg-purple-900/20 whitespace-nowrap overflow-hidden">
            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center border border-yellow-400 shrink-0">
                <i class="fas fa-user text-yellow-400"></i>
            </div>
            <div>
                <p class="text-sm font-bold">المدير العام</p>
                <p class="text-xs text-gray-300">Admin</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <a href="index.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-th-large w-5"></i> الرئيسية</a>
            <a href="products.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-box w-5"></i> الأصناف</a>
            <a href="quotations.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-file-invoice-dollar w-5"></i> عروض الأسعار</a>
            <a href="production_orders.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-industry w-5"></i> أوامر التشغيل</a>
            <a href="inventory.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-cubes w-5"></i> المستودعات</a>
            <a href="suppliers.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-truck w-5"></i> الموردين</a>
            <a href="clients.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-users w-5"></i> العملاء</a>
            <a href="employees.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-id-card w-5"></i> الموظفين</a>
            <a href="lists.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-list-alt w-5"></i> القوائم</a>
            <a href="permissions.html" class="sidebar-item active flex items-center gap-3 px-6 py-3 text-white font-medium whitespace-nowrap"><i class="fas fa-user-shield w-5"></i> الصلاحيات</a>
            <a href="tasks.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-tasks w-5"></i> المهام</a>
            <a href="terms.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-file-signature w-5"></i> الشروط العامة</a>
        </nav>
        
        <div class="p-4 border-t border-purple-800/50">
            <button class="w-full flex items-center justify-center gap-2 text-red-300 hover:text-red-100 transition-colors py-2 whitespace-nowrap">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative w-full transition-all duration-300">
        <header class="h-20 bg-white shadow-sm flex items-center justify-between px-4 md:px-8 z-10 shrink-0 no-print">
            <div class="flex items-center gap-3 shrink-0">
                <button onclick="toggleSidebar()" class="text-gray-600 text-xl focus:outline-none hover:text-gpack-purple p-2 rounded-md hover:bg-gray-100">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="text-lg md:text-xl font-bold text-gray-800 whitespace-nowrap">سجل الموردين</h2>
                <div id="loadingIndicator" class="hidden flex items-center gap-2 text-sm text-purple-600 bg-purple-50 px-3 py-1 rounded-full"><i class="fas fa-sync fa-spin"></i></div>
            </div>
            
            <div class="flex items-center gap-2 overflow-x-auto whitespace-nowrap hide-scrollbar flex-1 justify-end pl-2">
                <button onclick="openGlobalTransaction('invoice')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2">
                    <i class="fas fa-cart-plus"></i> شراء
                </button>
                <button onclick="openGlobalTransaction('return')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2">
                    <i class="fas fa-undo"></i> مردود
                </button>
                <button onclick="openGlobalTransaction('payment')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2">
                    <i class="fas fa-money-bill"></i> دفعة
                </button>
                <div class="w-px h-8 bg-gray-300 mx-1 shrink-0"></div>
                <button onclick="openAddModal()" class="gpack-btn px-4 py-2 rounded-lg font-bold text-sm shadow-md flex items-center gap-2">
                    <i class="fas fa-plus"></i><span>مورد جديد</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 no-print">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden overflow-x-auto">
                <table class="w-full text-right min-w-[700px]">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                        <tr>
                            <th class="px-6 py-4">اسم المورد / الشركة</th>
                            <th class="px-6 py-4">المسؤول</th>
                            <th class="px-6 py-4">نوع التوريد</th>
                            <th class="px-6 py-4">الجوال</th>
                            <th class="px-6 py-4">المواقع</th>
                            <th class="px-6 py-4 text-center">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="suppliersTableBody" class="divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="supplierModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeModal('supplierModal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-lg z-50 p-6 transform transition-all scale-95">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <p class="text-xl font-bold text-purple-800" id="modalTitle">إضافة مورد جديد</p>
                <button onclick="closeModal('supplierModal')"><i class="fas fa-times text-gray-500"></i></button>
            </div>
            <form id="supplierForm" class="space-y-4">
                <input type="hidden" id="sId">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold block mb-1">اسم المورد / الشركة</label><input type="text" id="sName" class="input-std" required></div>
                    <div><label class="text-sm font-bold block mb-1">المسؤول</label><input type="text" id="sPerson" class="input-std"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold block mb-1">الجوال</label><input type="text" id="sPhone" class="input-std"></div>
                    <div><label class="text-sm font-bold block mb-1">المدينة</label><input type="text" id="sCity" class="input-std"></div>
                </div>
                <div>
                    <label class="text-sm font-bold block mb-1">نوع التوريد</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="supplyInput" class="input-std" placeholder="اكتب النوع واضغط إضافة">
                        <button type="button" onclick="addSupplyTag()" class="bg-purple-100 text-purple-700 px-4 rounded text-sm font-bold hover:bg-purple-200">إضافة</button>
                    </div>
                    <div id="tagsContainer" class="flex flex-wrap gap-2 min-h-[30px] p-2 bg-gray-50 rounded border border-dashed border-gray-300"></div>
                </div>
                <div>
                    <label class="text-sm font-bold block mb-1">المواقع</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="locLabel" class="w-1/3 input-std" placeholder="اسم الفرع">
                        <input type="text" id="locUrl" class="flex-1 input-std" placeholder="الرابط...">
                        <button type="button" onclick="addLocation()" class="bg-gray-100 text-gray-700 px-3 rounded hover:bg-gray-200"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="locationsContainer" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="pt-4 flex justify-end gap-2 border-t mt-4">
                    <button type="button" onclick="closeModal('supplierModal')" class="bg-gray-100 px-4 py-2 rounded text-gray-600 hover:bg-gray-200">إلغاء</button>
                    <button type="submit" id="saveBtn" class="gpack-btn px-6 py-2 rounded font-bold">حفظ البيانات</button>
                </div>
            </form>
        </div>
    </div>

    <div id="transModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60" onclick="closeModal('transModal')"></div>
        <div class="modal-container bg-white w-full max-w-5xl mx-4 rounded-xl shadow-2xl z-50 p-0 transform transition-all scale-95 flex flex-col max-h-[95vh]">
            
            <div class="bg-purple-900 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i id="transIcon" class="fas"></i> <span id="transTitle">...</span>
                </h3>
                <button onclick="closeModal('transModal')" class="text-white hover:text-red-300"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="p-4 md:p-6 overflow-y-auto flex-1">
                <form id="transForm" class="space-y-4">
                    <input type="hidden" id="transType">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded border">
                        <div>
                            <label class="text-xs font-bold text-gray-600 block mb-1">التاريخ</label>
                            <input type="date" id="transDate" class="input-std bg-white">
                        </div>
                        <div id="supplierSelectDiv">
                            <label class="text-xs font-bold text-gray-600 block mb-1">المورد</label>
                            <select id="transSupplierSelect" class="input-std bg-white"></select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-600 block mb-1">رقم المستند (تلقائي)</label>
                            <input type="text" id="transDoc" class="input-std bg-gray-100 text-gray-500 cursor-not-allowed serial-num" readonly placeholder="200XX-XXXX">
                        </div>
                        
                        <div class="md:col-span-3 flex flex-wrap gap-4 items-center pt-2 border-t mt-2">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="transTax" class="w-4 h-4 text-purple-600 rounded" checked onchange="updateTotals()">
                                <label for="transTax" class="text-sm font-bold text-gray-700">فاتورة ضريبية (15%)</label>
                            </div>
                            <div class="flex items-center gap-2 border-r pr-4" id="warehouseSelectContainer">
                                <label class="text-xs font-bold text-gray-600 whitespace-nowrap">توجيه/سحب البضاعة من مستودع:</label>
                                <select id="transWarehouse" class="input-std text-xs w-48 bg-white" onchange="recheckStockIfReturn()"></select>
                            </div>
                        </div>
                    </div>

                    <div id="productsSection" class="border rounded p-4 overflow-x-auto">
                        <div class="flex justify-between items-center mb-2 min-w-[600px]">
                            <h4 class="font-bold text-sm text-gray-700">الأصناف</h4>
                            <button type="button" onclick="addTransItem()" class="text-purple-600 text-xs font-bold hover:underline bg-purple-50 px-2 py-1 rounded">+ إضافة صنف</button>
                        </div>
                        <table class="w-full text-right text-xs min-w-[600px]">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 w-1/4">المنتج (الأب)</th>
                                    <th class="p-2 w-1/4">المقاس / الصنف (الابن)</th>
                                    <th class="p-2 w-24">الكمية</th>
                                    <th class="p-2 w-24">السعر</th>
                                    <th class="p-2 w-24">الإجمالي</th>
                                    <th class="p-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="transItemsBody"></tbody>
                            <tfoot class="bg-gray-50 font-bold border-t">
                                <tr>
                                    <td colspan="4" class="p-2 text-left">الإجمالي قبل الضريبة:</td>
                                    <td class="p-2" id="transSubtotal">0.00</td>
                                    <td></td>
                                </tr>
                                <tr id="taxRow" class="text-red-600">
                                    <td colspan="4" class="p-2 text-left">الضريبة (15%):</td>
                                    <td class="p-2" id="transTaxVal">0.00</td>
                                    <td></td>
                                </tr>
                                <tr class="text-lg text-purple-900 border-t-2">
                                    <td colspan="4" class="p-2 text-left">الإجمالي النهائي:</td>
                                    <td class="p-2" id="transTotal">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="paymentSection" class="hidden">
                        <label class="text-xs font-bold text-gray-600 block mb-1">المبلغ المدفوع</label>
                        <input type="number" step="0.01" id="paymentAmount" class="input-std text-xl font-bold text-green-700">
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-600 block mb-1">ملاحظات / شروط الدفع</label>
                        <textarea id="transDesc" rows="2" class="input-std"></textarea>
                    </div>
                </form>
            </div>

            <div class="p-4 bg-gray-50 border-t rounded-b-xl flex justify-between items-center shrink-0">
                <button type="button" id="printTransBtn" onclick="printCurrentTransaction()" class="hidden text-purple-700 hover:bg-purple-100 font-bold text-sm bg-white border border-purple-300 px-4 py-2 rounded shadow-sm transition">
                    <i class="fas fa-print"></i> طباعة المستند
                </button>
                <div class="flex gap-2">
                    <button type="button" onclick="closeModal('transModal')" class="bg-gray-200 px-6 py-2 rounded text-gray-700 font-bold hover:bg-gray-300">إغلاق</button>
                    <button type="button" onclick="submitTransaction()" id="saveTransBtn" class="gpack-btn px-8 py-2 rounded font-bold shadow-lg">حفظ وترحيل</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 no-print">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80" onclick="closeModal('profileModal')"></div>
        <div class="modal-container bg-white w-full h-full md:w-11/12 md:h-[95vh] mx-auto rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col transform transition-all scale-95">
            
            <div class="bg-purple-900 text-white p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-white/10 rounded-full flex items-center justify-center text-xl border border-yellow-400"><i class="fas fa-truck"></i></div>
                    <div>
                        <h2 class="text-lg md:text-xl font-bold" id="pNameDisplay">...</h2>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openContextTransaction('invoice')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs md:text-sm font-bold" title="فاتورة مشتريات"><i class="fas fa-plus"></i> <span class="hidden md:inline">فاتورة</span></button>
                    <button onclick="openContextTransaction('return')" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs md:text-sm font-bold" title="مردود مشتريات"><i class="fas fa-undo"></i> <span class="hidden md:inline">مردود</span></button>
                    <button onclick="openContextTransaction('payment')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs md:text-sm font-bold" title="تسديد دفعة"><i class="fas fa-money-bill"></i> <span class="hidden md:inline">دفعة</span></button>
                    <button onclick="closeModal('profileModal')" class="text-white hover:text-red-300 text-2xl ml-2"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                <div class="w-full md:w-64 bg-gray-50 p-4 border-l border-gray-200 overflow-y-auto shrink-0 flex flex-col gap-4">
                    <div class="text-sm text-gray-600 space-y-2">
                        <div class="flex items-center gap-2 bg-white p-2 rounded shadow-sm"><i class="fas fa-phone text-purple-600"></i> <span id="pPhone" class="font-bold"></span></div>
                        <div class="flex items-center gap-2 bg-white p-2 rounded shadow-sm"><i class="fas fa-map-marker-alt text-purple-600"></i> <span id="pCity"></span></div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-xl border border-purple-100 shadow-md">
                        <h3 class="font-bold text-purple-900 mb-3 text-center border-b pb-2">كشف سريع</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>دائن (له):</span> <span class="font-bold" id="pTotalPurchases">0</span></div>
                            <div class="flex justify-between"><span>مدين (أخذ):</span> <span class="font-bold text-green-600" id="pTotalPaid">0</span></div>
                            <div class="border-t pt-2 mt-2 flex justify-between font-bold text-red-600 text-lg"><span>الرصيد:</span> <span id="pBalance" class="dir-ltr">0</span></div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col bg-white overflow-hidden">
                    <div class="border-b border-gray-200 px-4 flex gap-4 overflow-x-auto bg-gray-50/50 whitespace-nowrap shrink-0 hide-scrollbar">
                        <button onclick="switchTab('finance')" id="tab-finance-btn" class="tab-btn active"><i class="fas fa-coins text-yellow-500"></i> كشف الحساب</button>
                        <button onclick="switchTab('current')" id="tab-current-btn" class="tab-btn"><i class="fas fa-industry text-blue-500"></i> أوامر التشغيل (الحالية)</button>
                        <button onclick="switchTab('completed')" id="tab-completed-btn" class="tab-btn"><i class="fas fa-check-circle text-green-500"></i> الأرشيف (المنتهية)</button>
                    </div>
                    
                    <div class="p-2 md:p-6 overflow-y-auto flex-1 bg-white relative">
                        <div id="tab-finance" class="profile-tab block">
                            <div class="overflow-x-auto">
                                <table class="w-full text-right text-xs border rounded border-gray-200 min-w-[600px]">
                                    <thead class="bg-gray-100 text-gray-700 font-bold">
                                        <tr>
                                            <th class="p-3">التاريخ</th>
                                            <th class="p-3">رقم المستند</th>
                                            <th class="p-3">البيان</th>
                                            <th class="p-3 text-green-700">مدين (لنا)</th>
                                            <th class="p-3 text-red-700">دائن (له)</th>
                                            <th class="p-3">الرصيد</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financeTable" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="tab-current" class="profile-tab hidden">
                            <table class="w-full text-right text-sm border min-w-[500px]">
                                <thead class="bg-blue-50 text-blue-900"><tr><th class="p-3">رقم الأمر</th><th class="p-3">التاريخ</th><th class="p-3">الحالة</th><th class="p-3">الإجمالي</th></tr></thead>
                                <tbody id="currentOrdersTable"></tbody>
                            </table>
                        </div>

                        <div id="tab-completed" class="profile-tab hidden">
                            <table class="w-full text-right text-sm border min-w-[500px]">
                                <thead class="bg-gray-100"><tr><th class="p-3">رقم الأمر</th><th class="p-3">تاريخ التسليم</th><th class="p-3">الإجمالي</th></tr></thead>
                                <tbody id="completedOrdersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="printableInvoice" class="hidden">
        <div class="print-header flex justify-between items-center">
            <div class="text-right">
                <h1 class="text-3xl font-bold mb-1" id="printMainTitle">فاتورة مشتريات</h1>
                <p class="text-sm opacity-80" id="printDocType">Purchase Invoice</p>
                <div class="mt-4 text-sm">
                    <p><strong>التاريخ:</strong> <span id="printDate"></span></p>
                    <p><strong>رقم المستند:</strong> <span id="printRef" class="serial-num font-mono text-yellow-400 font-bold text-lg"></span></p>
                </div>
            </div>
            <div class="text-center">
                 <img src="https://i.postimg.cc/L6xs5hQh/logo-g-pack.png" alt="G.PACK Logo" class="h-20 mb-2 mx-auto filter brightness-0 invert">
                 <p class="text-xs text-gray-300 mt-1">Packaging Solutions</p>
                 <p class="text-xs text-gray-300">CR: 4700121038 | VAT: 310033995300003</p>
            </div>
        </div>

        <div class="p-8">
            <div class="bg-gray-100 p-4 rounded border-r-4 border-purple-800 mb-8 flex justify-between">
                <div>
                    <h3 class="text-purple-900 font-bold mb-2">بيانات المورد:</h3>
                    <p class="font-bold text-xl" id="printSupplier">-</p>
                </div>
                <div class="text-left" id="printWarehouseDiv">
                     <p class="text-xs text-gray-500" id="printWarehouseLabel">تم التوريد إلى مستودع:</p>
                     <p class="font-bold text-lg" id="printWarehouseName">-</p>
                </div>
            </div>

            <table class="w-full text-right print-table mb-8 border border-gray-200">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="35%" class="text-right">المنتج (الصنف)</th>
                        <th width="20%">المقاس</th>
                        <th width="10%">الكمية</th>
                        <th width="15%">السعر</th>
                        <th width="15%">الإجمالي</th>
                    </tr>
                </thead>
                <tbody id="printItemsBody"></tbody>
            </table>

            <div class="flex justify-between items-start mt-8">
                <div class="w-1/2 text-xs text-gray-600 leading-relaxed pr-4">
                    <h4 class="font-bold text-purple-900 mb-2 border-b pb-1">الشروط والملاحظات:</h4>
                    <ul class="list-disc pr-4 space-y-1" id="printNotesArea">
                        <li>هذا المستند معتمد إلكترونياً من النظام.</li>
                    </ul>
                </div>

                <div class="w-1/3">
                    <div class="flex justify-between border-b border-gray-300 py-2">
                        <span class="font-bold text-gray-600">الإجمالي قبل الضريبة</span>
                        <span id="printSub" class="font-bold">0.00</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-300 py-2">
                        <span class="font-bold text-gray-600">ضريبة القيمة المضافة (15%)</span>
                        <span id="printTax" class="font-bold text-red-600">0.00</span>
                    </div>
                    <div class="flex justify-between py-2 bg-purple-100 px-2 mt-2 rounded">
                        <span class="font-bold text-purple-900 text-lg">الإجمالي النهائي</span>
                        <span id="printNet" class="font-bold text-purple-900 text-lg">0.00</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="fixed bottom-0 w-full bg-purple-900 h-4"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ipomgnqpmbdzvmmjactv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwb21nbnFwbWJkenZtbWphY3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNjk3NDUsImV4cCI6MjA4Njc0NTc0NX0.99dmOGTc0AmsBGGYV0eM3kKSpbYdb6f-0X2mYLnGPtA';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allSuppliers = [];
        let allProducts = []; 
        let uniqueParentProducts = []; 
        let allWarehouses = []; 
        let currentProfileId = null;
        let transItems = [];

        window.onload = async () => {
            document.getElementById('transDate').valueAsDate = new Date();
            await Promise.all([fetchSuppliers(), fetchProducts(), fetchWarehouses()]);
        };

        // --- Sidebar Logic ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth < 768) {
                sidebar.classList.toggle('sidebar-mobile-hidden');
                overlay.classList.toggle('hidden');
            } else {
                sidebar.classList.toggle('sidebar-collapsed');
            }
        }

        // --- Fetch Data ---
        async function fetchSuppliers() {
            const { data } = await supabaseClient.from('suppliers').select('*').order('created_at', {ascending: false});
            allSuppliers = data || [];
            renderSuppliers(allSuppliers);
            const sel = document.getElementById('transSupplierSelect');
            sel.innerHTML = '<option value="">اختر المورد...</option>';
            allSuppliers.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.company_name}</option>`);
        }

        async function fetchProducts() {
            const { data } = await supabaseClient.from('product_variants').select('*, products(id, name)');
            allProducts = data || [];
            const parents = {};
            allProducts.forEach(v => { if(v.products) parents[v.products.id] = v.products.name; });
            uniqueParentProducts = Object.entries(parents).map(([id, name]) => ({id, name}));
        }
        
        async function fetchWarehouses() {
            const { data } = await supabaseClient.from('warehouses').select('*').order('created_at');
            allWarehouses = data || [];
            const sel = document.getElementById('transWarehouse');
            sel.innerHTML = '<option value="">اختر المستودع...</option>';
            allWarehouses.forEach(w => { sel.innerHTML += `<option value="${w.id}">${w.name}</option>`; });
        }

        function renderSuppliers(list) {
            const tbody = document.getElementById('suppliersTableBody');
            tbody.innerHTML = '';
            list.forEach(s => {
                let tags = (s.supply_types || []).slice(0,3).map(t => `<span class="supply-tag">${t}</span>`).join('');
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b transition-colors">
                        <td class="px-6 py-4 font-bold text-gray-800 whitespace-nowrap">${s.company_name || 'غير معروف'}</td>
                        <td class="px-6 py-4 text-gray-600 whitespace-nowrap">${s.contact_person || '-'}</td>
                        <td class="px-6 py-4">${tags}</td>
                        <td class="px-6 py-4 font-mono text-xs whitespace-nowrap">${s.phone || '-'}</td>
                        <td class="px-6 py-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${(s.locations||[]).length} موقع</span></td>
                        <td class="px-6 py-4 flex gap-3 justify-center">
                            <button onclick="openProfile('${s.id}')" class="text-purple-600 hover:text-purple-800 p-2 bg-purple-50 rounded-full"><i class="fas fa-folder-open"></i></button>
                            <button onclick="editSupplier('${s.id}')" class="text-blue-500 hover:text-blue-700 p-2 bg-blue-50 rounded-full"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // --- Transaction Modal ---
        function openGlobalTransaction(type) {
            currentProfileId = null;
            document.getElementById('supplierSelectDiv').classList.remove('hidden');
            setupTransModal(type);
        }

        function openContextTransaction(type) {
            document.getElementById('supplierSelectDiv').classList.add('hidden');
            document.getElementById('transSupplierSelect').value = currentProfileId;
            setupTransModal(type);
        }

        function setupTransModal(type) {
            document.getElementById('transForm').reset();
            document.getElementById('transType').value = type;
            document.getElementById('transDate').valueAsDate = new Date();
            transItems = [];
            
            const titles = { 'invoice': 'فاتورة مشتريات (إضافة للمخزون)', 'return': 'مردود مشتريات (خصم من المخزون)', 'payment': 'تسجيل دفعة نقدية' };
            const icons = { 'invoice': 'fa-cart-plus', 'return': 'fa-undo', 'payment': 'fa-money-bill' };
            document.getElementById('transTitle').innerText = titles[type];
            document.getElementById('transIcon').className = `fas ${icons[type]}`;
            
            const year = new Date().getFullYear().toString().substr(-2);
            document.getElementById('transDoc').placeholder = `سيتم الإنشاء تلقائياً: 200${year}-XXXX`;

            if(type === 'payment') {
                document.getElementById('productsSection').classList.add('hidden');
                document.getElementById('paymentSection').classList.remove('hidden');
                document.getElementById('warehouseSelectContainer').classList.add('hidden');
            } else {
                document.getElementById('productsSection').classList.remove('hidden');
                document.getElementById('paymentSection').classList.add('hidden');
                document.getElementById('warehouseSelectContainer').classList.remove('hidden');
                if(transItems.length === 0) addTransItem();
                else renderTransItems();
            }

            document.getElementById('saveTransBtn').classList.remove('hidden');
            document.getElementById('printTransBtn').classList.add('hidden');
            openModal('transModal');
        }

        function addTransItem() {
            transItems.push({ parentId: '', variantId: '', parentName: '', variantName: '', qty: 1, price: 0, availableStock: null });
            renderTransItems();
        }

        function renderTransItems() {
            let parentOpts = '<option value="">اختر المنتج...</option>';
            uniqueParentProducts.forEach(p => { parentOpts += `<option value="${p.id}">${p.name}</option>`; });

            const tbody = document.getElementById('transItemsBody');
            tbody.innerHTML = '';
            
            const type = document.getElementById('transType').value;

            transItems.forEach((item, index) => {
                const rowTotal = item.qty * item.price;

                let variantOpts = '<option value="">اختر المقاس...</option>';
                if(item.parentId) {
                    const filtered = allProducts.filter(p => p.products.id === item.parentId);
                    filtered.forEach(v => {
                        const sel = v.id === item.variantId ? 'selected' : '';
                        variantOpts += `<option value="${v.id}" ${sel}>${v.size_name}</option>`;
                    });
                } else {
                    variantOpts = '<option value="" disabled>اختر المنتج أولاً</option>';
                }

                let currentParentOpts = parentOpts.replace(`value="${item.parentId}"`, `value="${item.parentId}" selected`);
                
                // Show available stock warning for Returns
                let stockHint = '';
                if(type === 'return' && item.availableStock !== null) {
                    stockHint = `<div class="text-[10px] mt-1 ${item.qty > item.availableStock ? 'text-red-600 font-bold' : 'text-green-600'}">المتاح: ${item.availableStock}</div>`;
                }

                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-1">
                            <select onchange="updateItemParent(${index}, this)" class="input-std text-xs bg-gray-50 border-purple-200 font-bold">${currentParentOpts}</select>
                        </td>
                        <td class="p-1">
                            <select onchange="updateItemVariant(${index}, this)" class="input-std text-xs">${variantOpts}</select>
                        </td>
                        <td class="p-1 align-top relative">
                            <input type="number" value="${item.qty}" 
                                   oninput="updateItemData(${index}, 'qty', this.value)" 
                                   onkeydown="handleEnterNavigation(event, this)" 
                                   class="input-std text-center nav-input">
                            ${stockHint}
                        </td>
                        <td class="p-1 align-top">
                            <input type="number" value="${item.price}" 
                                   oninput="updateItemData(${index}, 'price', this.value)" 
                                   onkeydown="handleEnterNavigation(event, this)" 
                                   class="input-std text-center nav-input">
                        </td>
                        <td class="p-1 align-top pt-3 font-bold text-gray-700" id="rowTotal_${index}">${rowTotal.toFixed(2)}</td>
                        <td class="p-1 align-top text-center pt-2"><button type="button" onclick="transItems.splice(${index},1); renderTransItems()" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });

            updateTotals();
        }

        // --- UPDATE DATA WITHOUT RE-RENDERING HTML ---
        function updateItemData(index, field, val) {
            transItems[index][field] = parseFloat(val) || 0;
            
            // Update the row's total dynamically
            const rowTotal = transItems[index].qty * transItems[index].price;
            const rowTotalTd = document.getElementById(`rowTotal_${index}`);
            if(rowTotalTd) rowTotalTd.innerText = rowTotal.toFixed(2);
            
            // Re-eval stock warning color dynamically for returns
            const type = document.getElementById('transType').value;
            if(type === 'return' && field === 'qty' && transItems[index].availableStock !== null) {
                // To keep it simple without full re-render, we just re-render to update the hint properly if needed
                // But for pure speed, the user will see the red text on validation anyway.
            }
            
            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;
            transItems.forEach(item => { subtotal += (item.qty * item.price); });
            const taxRate = document.getElementById('transTax').checked ? 0.15 : 0;
            const taxVal = subtotal * taxRate;
            document.getElementById('transSubtotal').innerText = subtotal.toFixed(2);
            document.getElementById('transTaxVal').innerText = taxVal.toFixed(2);
            document.getElementById('transTotal').innerText = (subtotal + taxVal).toFixed(2);
            document.getElementById('taxRow').style.visibility = taxRate > 0 ? 'visible' : 'hidden';
        }

        function updateItemParent(index, el) {
            transItems[index].parentId = el.value;
            transItems[index].parentName = el.options[el.selectedIndex].text;
            transItems[index].variantId = ''; 
            transItems[index].variantName = '';
            transItems[index].availableStock = null;
            renderTransItems();
        }
        
        async function updateItemVariant(index, el) {
            transItems[index].variantId = el.value;
            transItems[index].variantName = el.options[el.selectedIndex].text;
            await checkStockForItem(index);
            renderTransItems();
        }

        // Live check stock for returns
        async function checkStockForItem(index) {
            const type = document.getElementById('transType').value;
            const whId = document.getElementById('transWarehouse').value;
            const varId = transItems[index].variantId;
            
            if (type === 'return' && whId && varId) {
                const { data } = await supabaseClient.from('warehouse_stock')
                    .select('quantity').eq('warehouse_id', whId).eq('variant_id', varId).is('client_id', null).single();
                transItems[index].availableStock = data ? data.quantity : 0;
            } else {
                transItems[index].availableStock = null;
            }
        }

        // Recheck all items if warehouse changes
        async function recheckStockIfReturn() {
            const type = document.getElementById('transType').value;
            if(type === 'return') {
                for(let i=0; i<transItems.length; i++) { await checkStockForItem(i); }
                renderTransItems();
            }
        }

        // --- EXCEL LIKE ENTER NAVIGATION ---
        function handleEnterNavigation(e, el) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Stop form submission
                
                // Get all navigation inputs currently on screen
                const inputs = Array.from(document.querySelectorAll('.nav-input'));
                const currentIndex = inputs.indexOf(el);
                
                if (e.shiftKey) {
                    // Shift+Enter goes backward
                    if (currentIndex > 0) {
                        inputs[currentIndex - 1].focus();
                        inputs[currentIndex - 1].select();
                    }
                } else {
                    // Enter goes forward
                    if (currentIndex > -1 && currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                        inputs[currentIndex + 1].select();
                    } else if (currentIndex === inputs.length - 1) {
                        // If it's the very last input (price), add a new row automatically
                        addTransItem();
                        // Wait a tiny bit for DOM to render the new row, then focus its first input (qty)
                        setTimeout(() => {
                            const newInputs = Array.from(document.querySelectorAll('.nav-input'));
                            if(newInputs.length > currentIndex + 1) {
                                newInputs[currentIndex + 1].focus();
                                newInputs[currentIndex + 1].select();
                            }
                        }, 50);
                    }
                }
            }
        }

        // --- SUBMIT TRANSACTION ---
        async function submitTransaction() {
            const type = document.getElementById('transType').value;
            const supplierId = document.getElementById('transSupplierSelect').value || currentProfileId;
            const date = document.getElementById('transDate').value;
            const desc = document.getElementById('transDesc').value;
            const warehouseId = document.getElementById('transWarehouse').value; 
            
            if(!supplierId) return alert("الرجاء اختيار المورد");
            if(type !== 'payment' && !warehouseId) return alert("الرجاء اختيار المستودع");
            
            let amount = 0;
            if(type === 'payment') amount = parseFloat(document.getElementById('paymentAmount').value);
            else amount = parseFloat(document.getElementById('transTotal').innerText);

            if(amount <= 0 || isNaN(amount)) return alert("المبلغ يجب أن يكون أكبر من صفر");

            // --- STRICT VALIDATION FOR RETURNS BEFORE INSERT ---
            if (type === 'return') {
                for (let i=0; i<transItems.length; i++) {
                    const item = transItems[i];
                    if(!item.variantId) return alert("يرجى التأكد من اختيار جميع الأصناف والمقاسات");
                    
                    const { data } = await supabaseClient.from('warehouse_stock').select('quantity')
                        .eq('warehouse_id', warehouseId).eq('variant_id', item.variantId).is('client_id', null).single();
                    
                    const available = data ? data.quantity : 0;
                    if (item.qty > available) {
                        return alert(`تنبيه: الكمية المطلوبة للمردود للصنف (${item.parentName}) أكبر من الرصيد المتاح في المستودع!\nالمتاح حالياً: ${available}`);
                    }
                }
            }

            document.getElementById('saveTransBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
            document.getElementById('saveTransBtn').disabled = true;

            const { count } = await supabaseClient.from('supplier_transactions').select('*', { count: 'exact', head: true });
            const nextSeq = (count || 0) + 1;
            const year = new Date().getFullYear().toString().substr(-2);
            const serialPrefix = type === 'payment' ? 'PAY' : '200';
            const docNum = `${serialPrefix}${year}-${String(nextSeq).padStart(4, '0')}`;

            const { data: transData, error } = await supabaseClient.from('supplier_transactions').insert([{
                supplier_id: supplierId,
                type: type,
                amount: amount,
                description: desc,
                document_number: docNum,
                created_at: date,
                items: transItems,
                warehouse_id: warehouseId || null, 
                is_taxable: document.getElementById('transTax').checked
            }]).select().single();

            document.getElementById('saveTransBtn').innerHTML = 'حفظ وترحيل';
            document.getElementById('saveTransBtn').disabled = false;

            if(error) return alert("خطأ في الحفظ: " + error.message);

            alert(`تم الحفظ بنجاح رقم السند: ${docNum}`);
            viewTransaction(transData); 
            if(currentProfileId) loadSupplierFinancials(currentProfileId);
        }

        // --- VIEW & PRINT ---
        function viewTransaction(t) {
            setupTransModal(t.type); 
            
            document.getElementById('transSupplierSelect').value = t.supplier_id;
            document.getElementById('transDate').value = t.created_at.split('T')[0];
            document.getElementById('transDoc').value = t.document_number;
            document.getElementById('transDesc').value = t.description;
            document.getElementById('transTax').checked = t.is_taxable;
            if(t.warehouse_id) document.getElementById('transWarehouse').value = t.warehouse_id;

            if(t.type === 'payment') {
                document.getElementById('paymentAmount').value = t.amount;
            } else {
                transItems = t.items || [];
                renderTransItems();
            }

            document.getElementById('saveTransBtn').classList.add('hidden');
            document.getElementById('printTransBtn').classList.remove('hidden');
            document.getElementById('transTitle').innerText += " (عرض)";
            window.currentViewingTrans = t;
        }

        function printCurrentTransaction() {
            const t = window.currentViewingTrans;
            if(!t) return;

            let mainTitle = '';
            let docTypeEn = '';
            let whLabel = 'تم التوريد إلى مستودع:';
            
            if (t.type === 'invoice') {
                mainTitle = 'فاتورة مشتريات';
                docTypeEn = 'Purchase Invoice';
                whLabel = 'تم التوريد إلى مستودع:';
            } else if (t.type === 'return') {
                mainTitle = 'مردود مشتريات';
                docTypeEn = 'Purchase Return';
                whLabel = 'تم السحب من مستودع:';
            } else {
                mainTitle = 'سند صرف نقدية';
                docTypeEn = 'Payment Voucher';
            }

            document.getElementById('printMainTitle').innerText = mainTitle;
            document.getElementById('printDocType').innerText = docTypeEn;
            document.getElementById('printDate').innerText = t.created_at.split('T')[0];
            document.getElementById('printRef').innerText = t.document_number; 
            
            const s = allSuppliers.find(x => x.id === t.supplier_id);
            document.getElementById('printSupplier').innerText = s ? s.company_name : 'N/A';
            
            document.getElementById('printWarehouseLabel').innerText = whLabel;
            const wh = allWarehouses.find(w => w.id === t.warehouse_id);
            document.getElementById('printWarehouseName').innerText = wh ? wh.name : '-';
            document.getElementById('printWarehouseDiv').style.display = t.type === 'payment' ? 'none' : 'block';

            const tbody = document.getElementById('printItemsBody');
            tbody.innerHTML = '';
            
            if(t.type === 'payment') {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center font-bold text-xl border-b">دفعة نقدية مسددة للمورد<br><span class="text-sm font-normal">${t.description}</span></td></tr>`;
                document.getElementById('printSub').innerText = t.amount.toFixed(2);
                document.getElementById('printTax').innerText = "0.00";
                document.getElementById('printNet').innerText = t.amount.toFixed(2);
            } else {
                let sub = 0;
                (t.items || []).forEach((i, idx) => {
                    const tot = i.qty * i.price;
                    sub += tot;
                    tbody.innerHTML += `
                        <tr class="${idx % 2 === 0 ? 'print-row-even' : ''}">
                            <td>${idx + 1}</td>
                            <td class="font-bold text-purple-900 text-right pr-2">${i.parentName || '-'}</td>
                            <td>${i.variantName || '-'}</td>
                            <td class="font-bold">${i.qty}</td>
                            <td>${i.price}</td>
                            <td class="font-bold">${tot.toFixed(2)}</td>
                        </tr>`;
                });
                const tax = t.is_taxable ? (sub * 0.15) : 0;
                document.getElementById('printSub').innerText = sub.toFixed(2);
                document.getElementById('printTax').innerText = tax.toFixed(2);
                document.getElementById('printNet').innerText = (sub + tax).toFixed(2);
            }

            const notes = document.getElementById('printNotesArea');
            notes.innerHTML = '';
            if (t.type === 'invoice') notes.innerHTML = '<li>تم استلام البضاعة بحالة جيدة وإضافتها للمخزون.</li>';
            else if (t.type === 'return') notes.innerHTML = '<li>تم تسليم البضاعة المعادة للمورد.</li>';
            
            if(t.description) notes.innerHTML += `<li>ملاحظات: ${t.description}</li>`;
            notes.innerHTML += '<li>هذا المستند معتمد إلكترونياً من النظام.</li>';

            window.print();
        }

        // --- Profile ---
        async function openProfile(id) {
            currentProfileId = id;
            const s = allSuppliers.find(x => x.id === id);
            document.getElementById('pNameDisplay').innerText = s.company_name;
            document.getElementById('pPhone').innerText = s.phone || '-';
            document.getElementById('pCity').innerText = s.city || '-';
            openModal('profileModal');
            await Promise.all([loadSupplierFinancials(id), loadSupplierOrders(id)]);
        }

        function switchTab(name) {
            document.querySelectorAll('.profile-tab').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.remove('hidden');
            document.getElementById(`tab-${name}-btn`).classList.add('active');
        }

        async function loadSupplierFinancials(supplierId) {
            const tbody = document.getElementById('financeTable');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">تحميل...</td></tr>';
            const { data } = await supabaseClient.from('supplier_transactions').select('*').eq('supplier_id', supplierId).order('created_at', {ascending: true});
            tbody.innerHTML = '';
            let bal = 0, cred = 0, deb = 0;
            if(data) data.forEach(t => {
                let credit = t.type === 'invoice' ? t.amount : 0;
                let debit = t.type !== 'invoice' ? t.amount : 0;
                bal = bal + credit - debit;
                cred += credit; deb += debit;
                
                const typeNames = {'invoice': 'فاتورة', 'return': 'مردود', 'payment': 'دفعة'};
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-yellow-50 transition cursor-pointer';
                row.innerHTML = `
                    <td class="p-3 text-gray-500 whitespace-nowrap">${new Date(t.created_at).toLocaleDateString()}</td>
                    <td class="p-3 font-mono text-gray-600 font-bold serial-num text-right">${t.document_number || '-'}</td>
                    <td class="p-3 font-bold text-gray-800 whitespace-nowrap">${typeNames[t.type]}</td>
                    <td class="p-3 text-green-700 bg-green-50/30">${debit || '-'}</td>
                    <td class="p-3 text-red-700 bg-red-50/30">${credit || '-'}</td>
                    <td class="p-3 font-bold bg-gray-100 dir-ltr">${bal.toFixed(2)}</td>
                `;
                row.onclick = (e) => { e.stopPropagation(); viewTransaction(t); };
                tbody.appendChild(row);
            });
            document.getElementById('pTotalPurchases').innerText = cred.toFixed(2);
            document.getElementById('pTotalPaid').innerText = deb.toFixed(2);
            document.getElementById('pBalance').innerText = bal.toFixed(2);
        }
        
        async function loadSupplierOrders(supplierId) {
             const currentTbody = document.getElementById('currentOrdersTable');
            const completedTbody = document.getElementById('completedOrdersTable');
            currentTbody.innerHTML = ''; completedTbody.innerHTML = '';
            const { data } = await supabaseClient.from('supplier_orders').select('*').eq('supplier_id', supplierId);
            if(data) data.forEach(o => {
                const row = `<tr class="border-b"><td class="p-3 font-bold">#${o.order_number||'N/A'}</td><td class="p-3">${new Date(o.created_at).toLocaleDateString()}</td><td class="p-3"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${o.status}</span></td><td class="p-3 font-bold">${o.total_amount}</td></tr>`;
                if(o.status === 'completed') completedTbody.innerHTML += row.replace('bg-blue-100', 'bg-green-100');
                else currentTbody.innerHTML += row;
            });
        }

        // --- Modal Helpers ---
        function openModal(id) {
            const el = document.getElementById(id);
            el.classList.remove('opacity-0', 'pointer-events-none');
            el.querySelector('.modal-container').classList.remove('scale-95');
            el.querySelector('.modal-container').classList.add('scale-100');
        }
        function closeModal(id) {
            const el = document.getElementById(id);
            el.querySelector('.modal-container').classList.add('scale-95');
            el.querySelector('.modal-container').classList.remove('scale-100');
            setTimeout(() => el.classList.add('opacity-0', 'pointer-events-none'), 200);
        }
        
        // --- CRUD Suppliers ---
        function openAddModal() { document.getElementById('supplierForm').reset(); document.getElementById('sId').value=''; openModal('supplierModal'); }
        async function editSupplier(id) { 
            const s = allSuppliers.find(x => x.id === id); document.getElementById('sId').value = s.id; document.getElementById('sName').value = s.company_name;
            document.getElementById('sPerson').value = s.contact_person; document.getElementById('sPhone').value = s.phone; document.getElementById('sCity').value = s.city;
            openModal('supplierModal'); 
        }
        document.getElementById('supplierForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = { company_name: document.getElementById('sName').value, contact_person: document.getElementById('sPerson').value, phone: document.getElementById('sPhone').value, city: document.getElementById('sCity').value };
            const id = document.getElementById('sId').value;
            if(id) await supabaseClient.from('suppliers').update(payload).eq('id', id);
            else await supabaseClient.from('suppliers').insert([payload]);
            closeModal('supplierModal'); fetchSuppliers();
        });
    </script>
</body>
</html>
