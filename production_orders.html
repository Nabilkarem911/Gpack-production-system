<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.PACK - أوامر التشغيل والإنتاج</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .gpack-purple { background-color: #3e206d; }
        .gpack-yellow { color: #fccf4d; }
        .gpack-btn { background-color: #fccf4d; color: #3e206d; transition: all 0.3s; }
        .gpack-btn:hover { background-color: #e6bd45; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar-item:hover { background-color: rgba(255,255,255,0.1); border-right: 4px solid #fccf4d; }
        .sidebar-item.active { background-color: rgba(255,255,255,0.15); border-right: 4px solid #fccf4d; color: #fff; }
        
        .modal { transition: opacity 0.2s ease-in-out; }
        body.modal-active { overflow: hidden; }
        .tab-btn { border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; padding: 10px 15px; white-space: nowrap; }
        .tab-btn.active { border-bottom-color: #3e206d; color: #3e206d; font-weight: bold; background-color: #f9fafb; }
        .input-std { width: 100%; border: 1px solid #d1d5db; padding: 8px; border-radius: 6px; font-size: 0.875rem; outline: none; }
        .input-std:focus { border-color: #3e206d; box-shadow: 0 0 0 1px #3e206d; }
        
        .serial-num { direction: ltr; unicode-bidi: embed; display: inline-block; text-align: left; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #sidebar { transition: width 0.3s ease, transform 0.3s ease; }
        .sidebar-collapsed { width: 0 !important; overflow: hidden; }
        @media (max-width: 768px) {
            .sidebar-mobile-hidden { transform: translateX(100%); }
            .sidebar-collapsed { width: 16rem !important; }
        }

        /* --- PRINT STYLES --- */
        @media print {
            body * { visibility: hidden; }
            .printing-po #printablePO, .printing-po #printablePO * { visibility: visible; }
            .printing-inv #printableClientInvoice, .printing-inv #printableClientInvoice * { visibility: visible; }
            
            #printablePO, #printableClientInvoice { 
                position: absolute; left: 0; top: 0; width: 100%; min-height: 100%; 
                background: white; z-index: 99999; padding: 0; display: block !important; 
            }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .print-price-col { display: table-cell; }
            .hide-price .print-price-col { display: none !important; }
        }
        .print-header { background-color: #3e206d; color: white; padding: 20px; border-bottom: 4px solid #fccf4d; }
        .po-group-header { background-color: #f3f4f6; font-weight: bold; color: #3e206d; padding: 10px; border: 1px solid #d1d5db; border-bottom: none; margin-top: 15px; }
        .po-table, .inv-table { width: 100%; border-collapse: collapse; text-align: right; font-size: 12px; }
        .po-table th, .inv-table th { background-color: #e5e7eb; padding: 8px; border: 1px solid #d1d5db; }
        .po-table td, .inv-table td { padding: 8px; border: 1px solid #d1d5db; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-gray-100">

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <aside id="sidebar" class="w-64 gpack-purple text-white flex flex-col shadow-2xl z-30 fixed md:relative h-full sidebar-mobile-hidden md:transform-none shrink-0">
        <div class="h-20 flex items-center justify-between px-6 border-b border-purple-800/50">
            <h1 class="text-2xl font-bold tracking-wider flex items-center gap-2">
                <i class="fas fa-box-open gpack-yellow"></i> <span class="whitespace-nowrap">G.PACK</span>
            </h1>
            <button onclick="toggleSidebar()" class="md:hidden text-white hover:text-red-300"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="p-4 flex items-center gap-3 border-b border-purple-800/50 bg-purple-900/20 whitespace-nowrap overflow-hidden">
            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center border border-yellow-400 shrink-0">
                <i class="fas fa-user text-yellow-400"></i>
            </div>
            <div>
                <p class="text-sm font-bold">المدير العام</p>
                <p class="text-xs text-gray-300">Admin</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <a href="index.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-th-large w-5"></i> الرئيسية</a>
            <a href="products.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-box w-5"></i> الأصناف</a>
            <a href="quotations.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-file-invoice-dollar w-5"></i> عروض الأسعار</a>
            <a href="production_orders.html" class="sidebar-item active flex items-center gap-3 px-6 py-3 text-white font-medium whitespace-nowrap"><i class="fas fa-industry w-5"></i> أوامر التشغيل</a>
            <a href="inventory.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-cubes w-5"></i> المستودعات</a>
            <a href="suppliers.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-truck w-5"></i> الموردين</a>
            <a href="clients.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-users w-5"></i> العملاء</a>
            <a href="employees.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-id-card w-5"></i> الموظفين</a>
            <a href="lists.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-list-alt w-5"></i> القوائم</a>
            <a href="permissions.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-user-shield w-5"></i> الصلاحيات</a>
            <a href="tasks.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-tasks w-5"></i> المهام</a>
            <a href="terms.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-file-signature w-5"></i> الشروط العامة</a>
        </nav>
        
        <div class="p-4 border-t border-purple-800/50">
            <button class="w-full flex items-center justify-center gap-2 text-red-300 hover:text-red-100 transition-colors py-2 whitespace-nowrap">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative w-full transition-all duration-300">
        <header class="h-20 bg-white shadow-sm flex items-center justify-between px-4 md:px-8 z-10 shrink-0 no-print">
            <div class="flex items-center gap-3 shrink-0">
                <button onclick="toggleSidebar()" class="text-gray-600 text-xl focus:outline-none hover:text-gpack-purple p-2 rounded-md hover:bg-gray-100">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="text-lg md:text-xl font-bold text-gray-800 whitespace-nowrap">أوامر التشغيل والإنتاج</h2>
                <div id="loadingIndicator" class="hidden flex items-center gap-2 text-sm text-purple-600 bg-purple-50 px-3 py-1 rounded-full"><i class="fas fa-sync fa-spin"></i> جاري التحميل...</div>
            </div>
            
            <div class="flex items-center gap-2 overflow-x-auto whitespace-nowrap hide-scrollbar flex-1 justify-end pl-2">
                <button onclick="openSmartPOModal()" class="gpack-btn px-4 py-2 rounded-lg font-bold text-sm shadow-md flex items-center gap-2 border border-yellow-500">
                    <i class="fas fa-magic"></i><span>أمر إنتاج مورد (تجميعي)</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 no-print">
            <div class="bg-white rounded-t-2xl border-b border-gray-100 flex overflow-x-auto whitespace-nowrap hide-scrollbar">
                <button onclick="switchTab('pending_orders')" id="tab-pending_orders-btn" class="tab-btn active"><i class="fas fa-pause-circle text-orange-500"></i> معلقة (بانتظار الإنتاج)</button>
                <button onclick="switchTab('client_orders')" id="tab-client_orders-btn" class="tab-btn"><i class="fas fa-industry text-green-600"></i> أوامر العملاء (السارية)</button>
                <button onclick="switchTab('supplier_pos')" id="tab-supplier_pos-btn" class="tab-btn"><i class="fas fa-truck-loading text-blue-600"></i> أوامر الموردين (قيد التصنيع)</button>
                <button onclick="switchTab('archive')" id="tab-archive-btn" class="tab-btn"><i class="fas fa-archive text-gray-500"></i> الأرشيف (منتهية)</button>
            </div>

            <div class="bg-white rounded-b-2xl shadow-sm border border-gray-100 p-4 md:p-6 min-h-[500px]">
                
                <!-- تابة الطلبات المعلقة -->
                <div id="tab-pending_orders" class="tab-content block">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right text-sm min-w-[800px]">
                            <thead class="bg-orange-50 text-orange-900">
                                <tr>
                                    <th class="p-3">رقم الأمر</th>
                                    <th class="p-3">التاريخ</th>
                                    <th class="p-3">اسم العميل</th>
                                    <th class="p-3 text-center">الإجراءات (الإنتاج)</th>
                                </tr>
                            </thead>
                            <tbody id="pendingOrdersTable" class="divide-y divide-orange-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- تابة الأوامر السارية -->
                <div id="tab-client_orders" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row gap-3 mb-4 bg-gray-50 p-3 rounded-lg border">
                        <input type="text" id="searchClientOrders" oninput="filterClientOrders()" placeholder="بحث باسم العميل أو رقم الأمر..." class="input-std flex-1">
                        <select id="sortClientOrders" onchange="filterClientOrders()" class="input-std w-full md:w-48">
                            <option value="newest">الأحدث أولاً</option>
                            <option value="oldest">الأقدم أولاً</option>
                        </select>
                        <select id="statusClientOrders" onchange="filterClientOrders()" class="input-std w-full md:w-48">
                            <option value="all">كل الحالات المالية</option>
                            <option value="paid">خالص (مدفوع بالكامل)</option>
                            <option value="debt">متبقي دفعة</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right text-sm min-w-[800px]">
                            <thead class="bg-gray-100 text-gray-700">
                                <tr>
                                    <th class="p-3">رقم الأمر</th>
                                    <th class="p-3">التاريخ</th>
                                    <th class="p-3">اسم العميل</th>
                                    <th class="p-3">قيمة الأمر</th>
                                    <th class="p-3 text-green-700">المدفوع</th>
                                    <th class="p-3 text-red-700">المتبقي</th>
                                    <th class="p-3 text-center">الحالة</th>
                                    <th class="p-3 text-center">إدارة</th>
                                </tr>
                            </thead>
                            <tbody id="clientOrdersTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- تابة أوامر الموردين -->
                <div id="tab-supplier_pos" class="tab-content hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right text-sm min-w-[800px]">
                            <thead class="bg-blue-50 text-blue-900">
                                <tr>
                                    <th class="p-3">رقم طلب الإنتاج</th>
                                    <th class="p-3">التاريخ</th>
                                    <th class="p-3">المورد</th>
                                    <th class="p-3">تاريخ التسليم</th>
                                    <th class="p-3">الحالة</th>
                                    <th class="p-3 text-center">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="supplierPOTable" class="divide-y divide-blue-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- تابة الأرشيف -->
                <div id="tab-archive" class="tab-content hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right text-sm min-w-[700px]">
                            <thead class="bg-gray-100 text-gray-600">
                                <tr>
                                    <th class="p-3">رقم الأمر</th>
                                    <th class="p-3">التاريخ</th>
                                    <th class="p-3">اسم العميل</th>
                                    <th class="p-3">قيمة الأمر</th>
                                    <th class="p-3 text-center">عرض</th>
                                </tr>
                            </thead>
                            <tbody id="archivedOrdersTable" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- مودال: تحويل طلب واحد للإنتاج -->
    <div id="singleOrderPOModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60" onclick="closeModal('singleOrderPOModal')"></div>
        <div class="modal-container bg-white w-full max-w-6xl mx-4 rounded-xl shadow-2xl z-50 p-0 transform transition-all scale-95 flex flex-col max-h-[95vh]">
            <div class="bg-orange-600 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-cogs"></i> تحويل الطلب للإنتاج (إرسال للمورد)</h3>
                <button onclick="closeModal('singleOrderPOModal')" class="text-white hover:text-red-300"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-1 bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 rounded-lg shadow-sm border mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-600 block mb-1">اختر المورد المنفذ</label>
                        <select id="singlePoSupplierSelect" class="input-std font-bold text-purple-900"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600 block mb-1">تاريخ التسليم المتوقع</label>
                        <input type="date" id="singlePoExpectedDate" class="input-std">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600 block mb-1">إظهار الأسعار في الطباعة؟</label>
                        <select id="singlePoPrintPriceToggle" class="input-std">
                            <option value="hide">إخفاء الأسعار (للمصنع فقط)</option>
                            <option value="show">إظهار السعر المرجعي</option>
                        </select>
                    </div>
                </div>
                <h4 class="font-bold text-gray-800 mb-2 border-r-4 border-orange-400 pr-2">أصناف هذا الطلب (حدد ما تريد إرساله للمورد)</h4>
                <div class="bg-white border rounded-lg overflow-x-auto shadow-sm">
                    <table class="w-full text-right text-sm min-w-[900px]">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="p-3 w-10 text-center"><input type="checkbox" id="selectAllSinglePoItems" onchange="toggleAllSinglePoItems(this)"></th>
                                <th class="p-3">الصنف / المقاس</th>
                                <th class="p-3 text-center">الكمية المطلوبة</th>
                                <th class="p-3 text-center bg-blue-50 text-blue-800">آخر سعر توريد</th>
                                <th class="p-3 w-40">الحالة التصنيعية (إلزامي)</th>
                                <th class="p-3">ملاحظات للمطبعة</th>
                            </tr>
                        </thead>
                        <tbody id="singlePoAvailableItemsBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-white border-t rounded-b-xl flex justify-between items-center shrink-0">
                <p class="text-xs text-gray-500"><i class="fas fa-info-circle text-blue-500"></i> الأصناف التي يتم إرسالها ستختفي من هذه القائمة.</p>
                <div class="flex gap-2">
                    <button type="button" onclick="closeModal('singleOrderPOModal')" class="bg-gray-200 px-6 py-2 rounded font-bold hover:bg-gray-300">إلغاء</button>
                    <button type="button" id="btnSubmitSinglePO" onclick="submitSingleSupplierPO()" class="bg-orange-600 text-white px-8 py-2 rounded font-bold shadow-lg hover:bg-orange-700">حفظ وإنشاء أمر طباعة المورد</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال: أمر إنتاج تجميعي (Smart PO) -->
    <div id="smartPOModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60" onclick="closeModal('smartPOModal')"></div>
        <div class="modal-container bg-white w-full max-w-6xl mx-4 rounded-xl shadow-2xl z-50 p-0 transform transition-all scale-95 flex flex-col max-h-[95vh]">
            <div class="bg-purple-900 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-magic text-yellow-400"></i> إنشاء أمر إنتاج مجمع (للمورد)</h3>
                <button onclick="closeModal('smartPOModal')" class="text-white hover:text-red-300"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-1 bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 rounded-lg shadow-sm border mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-600 block mb-1">اختر المورد المنفذ</label>
                        <select id="poSupplierSelect" class="input-std font-bold text-purple-900"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600 block mb-1">تاريخ التسليم المتوقع</label>
                        <input type="date" id="poExpectedDate" class="input-std">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600 block mb-1">إظهار الأسعار في الطباعة؟</label>
                        <select id="poPrintPriceToggle" class="input-std">
                            <option value="hide">إخفاء الأسعار (للمصنع فقط)</option>
                            <option value="show">إظهار آخر سعر شراء</option>
                        </select>
                    </div>
                </div>
                <h4 class="font-bold text-gray-800 mb-2 border-r-4 border-yellow-400 pr-2">الأصناف المتاحة للإنتاج (لم يتم طلبها من مورد بعد)</h4>
                <div class="bg-white border rounded-lg overflow-x-auto shadow-sm">
                    <table class="w-full text-right text-sm min-w-[900px]">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="p-3 w-10 text-center"><input type="checkbox" id="selectAllPoItems" onchange="toggleAllPoItems(this)"></th>
                                <th class="p-3">رقم الأمر (العميل)</th>
                                <th class="p-3">الصنف / المقاس</th>
                                <th class="p-3 text-center">الكمية</th>
                                <th class="p-3 text-center text-blue-700 bg-blue-50">آخر سعر توريد</th>
                                <th class="p-3 w-40">الحالة التصنيعية (إلزامي)</th>
                                <th class="p-3">ملاحظات للمطبعة</th>
                            </tr>
                        </thead>
                        <tbody id="poAvailableItemsBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-white border-t rounded-b-xl flex justify-between items-center shrink-0">
                <p class="text-xs text-gray-500"><i class="fas fa-info-circle text-blue-500"></i> سيتم إخفاء الأصناف التي يتم إرسالها للمورد من هذه القائمة.</p>
                <div class="flex gap-2">
                    <button type="button" onclick="closeModal('smartPOModal')" class="bg-gray-200 px-6 py-2 rounded font-bold hover:bg-gray-300">إلغاء</button>
                    <button type="button" id="btnSubmitSmartPO" onclick="submitSupplierPO()" class="gpack-btn px-8 py-2 rounded font-bold shadow-lg">حفظ وإنشاء أمر الطباعة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال: تفاصيل أمر المورد -->
    <div id="poDetailsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60" onclick="closeModal('poDetailsModal')"></div>
        <div class="modal-container bg-white w-full max-w-4xl mx-4 rounded-xl shadow-2xl z-50 p-0 transform transition-all scale-95 flex flex-col max-h-[90vh]">
            <div class="bg-blue-800 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="text-lg font-bold">تفاصيل طلب المورد <span id="viewPoNum" class="text-yellow-300 serial-num"></span></h3>
                <button onclick="closeModal('poDetailsModal')" class="text-white hover:text-red-300"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <table class="w-full text-right text-sm border">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 border">العميل</th>
                            <th class="p-2 border">الصنف / المقاس</th>
                            <th class="p-2 border text-center">الكمية</th>
                            <th class="p-2 border">حالة التصميم</th>
                            <th class="p-2 border">ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="poDetailsModalBody"></tbody>
                </table>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-xl flex justify-end gap-2 shrink-0">
                <button type="button" onclick="closeModal('poDetailsModal')" class="bg-gray-200 px-6 py-2 rounded font-bold">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- مودال: استلام بضاعة -->
    <div id="receivePOModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80" onclick="closeModal('receivePOModal')"></div>
        <div class="modal-container bg-white w-full max-w-4xl mx-4 rounded-xl shadow-2xl z-50 p-0 transform transition-all scale-95 flex flex-col max-h-[90vh]">
            <div class="bg-green-700 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="text-lg font-bold"><i class="fas fa-box-open"></i> استلام بضاعة وإنشاء فاتورة مشتريات</h3>
                <button onclick="closeModal('receivePOModal')" class="text-white hover:text-red-300"><i class="fas fa-times text-xl"></i></button>
            </div>
            <input type="hidden" id="receivePoId">
            <input type="hidden" id="receiveSupplierId">
            <div class="p-6 overflow-y-auto flex-1">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 text-sm text-yellow-800">
                    <strong>ملاحظة هامة:</strong> يمكنك إدخال جزء من الكمية (استلام جزئي) أو استلام كامل الكمية. سيتم ترحيل ما تدخله فقط للمخزن مع إنشاء مديونية للمورد تلقائياً.
                </div>
                <table class="w-full text-right text-sm border">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 border">العميل</th>
                            <th class="p-2 border">الصنف</th>
                            <th class="p-2 border text-center">المطلوب الأساسي</th>
                            <th class="p-2 border text-center bg-green-50 text-green-800 w-32">المستلم فعلياً (الآن)</th>
                            <th class="p-2 border text-center">سعر الوحدة</th>
                        </tr>
                    </thead>
                    <tbody id="receivePOItemsBody"></tbody>
                </table>
                <div class="mt-4 p-3 bg-gray-100 rounded border flex items-center gap-2">
                    <input type="checkbox" id="markPoCompleted" class="w-5 h-5 text-green-600 rounded">
                    <label for="markPoCompleted" class="font-bold cursor-pointer">إغلاق أمر المورد بالكامل (علم هنا إذا استلمت كل شيء ولن تستلم دفعات أخرى)</label>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-xl flex justify-end gap-2 shrink-0">
                <button type="button" onclick="closeModal('receivePOModal')" class="bg-gray-200 px-6 py-2 rounded font-bold">إلغاء</button>
                <button type="button" onclick="submitReceivePO()" id="btnConfirmReceive" class="bg-green-600 text-white px-8 py-2 rounded font-bold shadow-lg hover:bg-green-700">تأكيد الاستلام وإنشاء الفاتورة</button>
            </div>
        </div>
    </div>

    <!-- مودال: إدارة الأمر الرئيسي -->
    <div id="orderManagerModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80" onclick="closeModal('orderManagerModal')"></div>
        <div class="modal-container bg-white w-full h-full md:w-11/12 md:h-[95vh] mx-auto rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col transform transition-all scale-95">
            
            <div class="bg-purple-900 text-white p-4 flex justify-between items-center shrink-0">
                <div>
                    <h2 class="text-xl font-bold">إدارة أمر تشغيل <span id="mgrOrderNum" class="text-yellow-400 serial-num">#000</span></h2>
                    <p class="text-sm opacity-80 mt-1">العميل: <span id="mgrClientName" class="font-bold">...</span></p>
                </div>
                <button onclick="closeModal('orderManagerModal')" class="text-white hover:text-red-300 text-2xl"><i class="fas fa-times"></i></button>
            </div>

            <input type="hidden" id="mgrActiveOrderId">
            <input type="hidden" id="mgrActiveClientId">

            <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
                <div class="bg-white border-b px-6 flex gap-6 shrink-0 pt-2 overflow-x-auto hide-scrollbar">
                    <button onclick="switchMgrTab('items')" id="mgr-tab-items" class="tab-btn active"><i class="fas fa-box"></i> أصناف الأمر</button>
                    <button onclick="switchMgrTab('invoices')" id="mgr-tab-invoices" class="tab-btn"><i class="fas fa-file-invoice-dollar"></i> الفواتير والحسابات</button>
                    <button onclick="switchMgrTab('deliveries')" id="mgr-tab-deliveries" class="tab-btn"><i class="fas fa-truck-loading"></i> سندات التسليم</button>
                </div>
                
                <div class="p-6 overflow-y-auto flex-1 relative">
                    <div id="mgr-content-items" class="block">
                        <div class="bg-white rounded-lg shadow-sm border p-4">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 class="font-bold text-gray-700">تفاصيل الأصناف المطلوبة</h3>
                                <button onclick="closeOrderManually()" class="text-xs bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 font-bold"><i class="fas fa-archive"></i> إنهاء الأمر (أرشفة)</button>
                            </div>
                            <div id="mgrItemsLoading" class="text-center py-4 text-gray-400"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>
                            <table class="w-full text-right text-sm hidden" id="mgrItemsTable">
                                <thead class="bg-gray-50"><tr><th class="p-2">الصنف (المقاس)</th><th class="p-2 text-center">الكمية المطلوبة</th><th class="p-2 text-center">سعر الوحدة</th><th class="p-2 text-center">الإجمالي</th></tr></thead>
                                <tbody id="mgrItemsBody" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="mgr-content-invoices" class="hidden">
                        <div class="flex flex-wrap gap-4 mb-6">
                            <button onclick="openInvoiceModal('proforma')" class="bg-blue-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-blue-700"><i class="fas fa-file-alt"></i> إصدار فاتورة أولية (مالية)</button>
                            <button onclick="openInvoiceModal('final')" class="bg-purple-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-purple-700"><i class="fas fa-check-double"></i> إصدار فاتورة مبيعات (خصم من المخزون)</button>
                            <button onclick="openPaymentModal()" class="bg-green-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-green-700 mr-auto"><i class="fas fa-money-bill-wave"></i> تسجيل دفعة مالية</button>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border p-4">
                            <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">سجل الفواتير الصادرة</h4>
                            <table class="w-full text-right text-sm">
                                <thead class="bg-gray-50"><tr><th class="p-2">التاريخ</th><th class="p-2">رقم الفاتورة</th><th class="p-2">النوع</th><th class="p-2">الإجمالي</th><th class="p-2 text-center">إجراء</th></tr></thead>
                                <tbody id="mgrInvoicesBody" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="mgr-content-deliveries" class="hidden">
                        <div class="flex gap-4 mb-6">
                            <button onclick="openDeliveryModal()" class="bg-green-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-green-700"><i class="fas fa-shipping-fast"></i> إصدار سند تسليم</button>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border p-4">
                            <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">سجلات التسليم السابقة</h4>
                            <table class="w-full text-right text-sm">
                                <thead class="bg-gray-50"><tr><th class="p-2">التاريخ</th><th class="p-2">الكمية المسلمة</th><th class="p-2">الصنف</th></tr></thead>
                                <tbody id="mgrDeliveriesBody" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال: تسجيل دفعة -->
    <div id="paymentModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[90]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80" onclick="closeModal('paymentModal')"></div>
        <div class="modal-container bg-white w-full max-w-md mx-4 rounded-xl shadow-2xl z-50 p-0 transform transition-all scale-95 flex flex-col">
            <div class="bg-green-700 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="text-lg font-bold"><i class="fas fa-hand-holding-usd"></i> تسجيل دفعة مالية للعميل</h3>
                <button onclick="closeModal('paymentModal')" class="text-white hover:text-red-300"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="text-sm font-bold text-gray-700 block mb-2">المبلغ المدفوع (ريال)</label>
                    <input type="number" id="paymentAmount" class="input-std text-lg font-bold text-green-700 text-center" placeholder="0.00">
                </div>
                <div class="mb-4">
                    <label class="text-sm font-bold text-gray-700 block mb-2">طريقة الدفع وملاحظات</label>
                    <input type="text" id="paymentNotes" class="input-std" placeholder="تحويل بنكي، كاش، الخ...">
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-xl flex justify-end gap-2">
                <button type="button" onclick="closeModal('paymentModal')" class="bg-gray-200 px-6 py-2 rounded font-bold">إلغاء</button>
                <button type="button" onclick="submitClientPayment()" id="btnSubmitPayment" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">تأكيد الدفعة</button>
            </div>
        </div>
    </div>

    <!-- مودال: إصدار فاتورة -->
    <div id="invoiceModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80" onclick="closeModal('invoiceModal')"></div>
        <div class="modal-container bg-white w-full max-w-4xl mx-4 rounded-xl shadow-2xl z-50 p-0 transform transition-all scale-95 flex flex-col max-h-[90vh]">
            <div class="bg-purple-900 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="text-lg font-bold" id="invoiceModalTitle">إصدار فاتورة</h3>
                <button onclick="closeModal('invoiceModal')" class="text-white hover:text-red-300"><i class="fas fa-times text-xl"></i></button>
            </div>
            <input type="hidden" id="invModalType">
            <div class="p-6 overflow-y-auto flex-1">
                <p class="text-sm text-gray-600 mb-4">يمكنك تعديل الكميات والأسعار قبل إصدار الفاتورة للعميل.</p>
                <table class="w-full text-right text-sm border mb-4">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 border">الصنف</th>
                            <th class="p-2 border text-center w-24">الكمية</th>
                            <th class="p-2 border text-center w-32">السعر</th>
                            <th class="p-2 border text-center w-32">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceItemsBody"></tbody>
                </table>
                <div class="flex justify-end">
                    <div class="w-64 bg-gray-50 p-3 rounded border">
                        <div class="flex justify-between text-sm mb-1"><span>الإجمالي:</span> <span id="invoiceTotalVal" class="font-bold">0.00</span></div>
                        <div class="flex justify-between text-sm mb-1 text-green-700"><span>الدفعة المقدمة (من العرض):</span> <span id="invoiceAdvanceVal" class="font-bold">0.00</span></div>
                        <input type="hidden" id="invAdvancePayment" value="0">
                        <div class="border-t border-gray-300 my-1"></div>
                        <div class="flex justify-between text-lg text-purple-900 font-bold"><span>المطلوب دفعه:</span> <span id="invoiceRemainingVal">0.00</span></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-xl flex justify-end gap-2 shrink-0">
                <button type="button" onclick="closeModal('invoiceModal')" class="bg-gray-200 px-6 py-2 rounded font-bold">إلغاء</button>
                <button type="button" onclick="submitInvoice()" class="gpack-btn px-8 py-2 rounded font-bold shadow-lg">حفظ وإصدار</button>
            </div>
        </div>
    </div>

    <!-- مودال: سند تسليم -->
    <div id="deliveryModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80" onclick="closeModal('deliveryModal')"></div>
        <div class="modal-container bg-white w-full max-w-4xl mx-4 rounded-xl shadow-2xl z-50 p-0 transform transition-all scale-95 flex flex-col max-h-[90vh]">
            <div class="bg-blue-800 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="text-lg font-bold"><i class="fas fa-shipping-fast"></i> إصدار سند تسليم بضاعة</h3>
                <button onclick="closeModal('deliveryModal')" class="text-white hover:text-red-300"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <p class="text-sm text-gray-600 mb-4">أدخل الكمية المراد تسليمها للمندوب لخصمها نهائياً من المستودع وتغيير حالتها إلى Delivered.</p>
                <table class="w-full text-right text-sm border">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 border">الصنف</th>
                            <th class="p-2 border text-center text-red-600">المحجوز بالمخزن (لم يسلم)</th>
                            <th class="p-2 border text-center text-blue-700 bg-blue-50">الكمية المُراد تسليمها الآن</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryItemsBody"></tbody>
                </table>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-xl flex justify-end gap-2 shrink-0">
                <button type="button" onclick="closeModal('deliveryModal')" class="bg-gray-200 px-6 py-2 rounded font-bold">إلغاء</button>
                <button type="button" onclick="submitDelivery()" class="bg-blue-600 text-white px-8 py-2 rounded font-bold shadow-lg hover:bg-blue-700">تأكيد التسليم</button>
            </div>
        </div>
    </div>

    <!-- قالب الطباعة: أمر إنتاج للمورد -->
    <div id="printablePO" class="hidden">
        <div class="print-header flex justify-between items-center">
            <div class="text-right">
                <h1 class="text-3xl font-bold mb-1">أمر إنتاج / طلب طباعة</h1>
                <p class="text-sm opacity-80">Production Order (PO)</p>
                <div class="mt-4 text-sm">
                    <p><strong>التاريخ:</strong> <span id="printPoDate"></span></p>
                    <p><strong>رقم الأمر:</strong> <span id="printPoNum" class="serial-num font-mono text-yellow-400 font-bold text-lg"></span></p>
                </div>
            </div>
            <div class="text-center">
                <img src="https://i.postimg.cc/L6xs5hQh/logo-g-pack.png" alt="G.PACK Logo" class="h-20 mb-2 mx-auto filter brightness-0 invert">
                <p class="text-xs text-gray-300 mt-1">Packaging Solutions</p>
            </div>
        </div>
        <div class="p-8">
            <div class="bg-gray-100 p-4 rounded border-r-4 border-purple-800 mb-8">
                <h3 class="text-purple-900 font-bold mb-2">إلى السادة / المطبعة:</h3>
                <p class="font-bold text-2xl" id="printPoSupplier">-</p>
                <p class="text-sm text-gray-600 mt-2">نرجو منكم التكرم بتنفيذ أمر الطباعة المرفق أدناه حسب المواصفات، على أن يكون موعد التسليم المتوقع في: <span id="printPoExpectedDate" class="font-bold text-red-600"></span>.</p>
            </div>
            <div id="printPoContent"></div>
            <div class="mt-12 pt-8 border-t border-gray-300 flex justify-between text-center text-sm font-bold text-gray-600">
                <div class="w-1/3">توقيع مسؤول الإنتاج<br><br>_________________</div>
                <div class="w-1/3">توقيع وتوجيه المورد<br><br>_________________</div>
            </div>
        </div>
    </div>

    <!-- قالب الطباعة: فاتورة العميل -->
    <div id="printableClientInvoice" class="hidden">
        <div class="print-header flex justify-between items-center">
            <div class="text-right">
                <h1 class="text-3xl font-bold mb-1" id="printInvTitle">فاتورة</h1>
                <p class="text-sm opacity-80" id="printInvTypeEn">Invoice</p>
                <div class="mt-4 text-sm">
                    <p><strong>التاريخ:</strong> <span id="printInvDate"></span></p>
                    <p><strong>رقم الفاتورة:</strong> <span id="printInvNum" class="serial-num font-mono text-yellow-400 font-bold text-lg"></span></p>
                </div>
            </div>
            <div class="text-center">
                <img src="https://i.postimg.cc/L6xs5hQh/logo-g-pack.png" alt="G.PACK Logo" class="h-20 mb-2 mx-auto filter brightness-0 invert">
                <p class="text-xs text-gray-300 mt-1">Packaging Solutions</p>
                <p class="text-xs text-gray-300 font-mono">CR: 4700121038 | VAT: 310033995300003</p>
            </div>
        </div>
        <div class="p-8">
            <div class="bg-gray-100 p-4 rounded border-r-4 border-purple-800 mb-8 flex justify-between">
                <div>
                    <h3 class="text-purple-900 font-bold mb-2">المطلوب من السادة:</h3>
                    <p class="font-bold text-xl" id="printInvClient">-</p>
                </div>
            </div>
            <table class="w-full text-right inv-table mb-8 border border-gray-200">
                <thead>
                    <tr><th width="5%">#</th><th width="45%">البيان (الصنف والمقاس)</th><th width="15%">الكمية</th><th width="15%">السعر</th><th width="20%">الإجمالي</th></tr>
                </thead>
                <tbody id="printInvItemsBody"></tbody>
            </table>
            <div class="flex justify-end mt-8">
                <div class="w-1/2">
                    <div class="flex justify-between border-b py-2"><span class="font-bold">الإجمالي قبل الضريبة:</span><span id="printInvSub" class="font-mono">0.00</span></div>
                    <div class="flex justify-between border-b py-2 text-red-600"><span class="font-bold">ضريبة القيمة المضافة (15%):</span><span id="printInvTax" class="font-mono">0.00</span></div>
                    <div class="flex justify-between py-2 bg-purple-100 px-2 mt-2 rounded"><span class="font-bold text-purple-900 text-lg">الإجمالي الشامل:</span><span id="printInvTotal" class="font-bold text-purple-900 text-lg font-mono">0.00</span></div>
                    <div class="flex justify-between border-b py-2 text-green-700 mt-2"><span class="font-bold">الدفعة المقدمة:</span><span id="printInvPaid" class="font-mono">0.00</span></div>
                    <div class="flex justify-between py-2"><span class="font-bold text-lg text-gray-800">المتبقي للدفع:</span><span id="printInvRem" class="font-bold text-lg font-mono text-gray-800">0.00</span></div>
                </div>
            </div>
        </div>
    </div>

<script>
    // =====================================================================
    // الإعدادات والمتغيرات العامة
    // =====================================================================
    const SUPABASE_URL = 'https://ipomgnqpmbdzvmmjactv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwb21nbnFwbWJkenZtbWphY3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNjk3NDUsImV4cCI6MjA4Njc0NTc0NX0.99dmOGTc0AmsBGGYV0eM3kKSpbYdb6f-0X2mYLnGPtA';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // =====================================================================
    // الكاش العالمي — كل البيانات الأساسية تُحمَّل مرة واحدة فقط
    // =====================================================================
    let allOrdersList    = [];   // كل orders بحالة production
    let pendingOrdersList = [];  // الطلبات التي لم يُرسَل أي صنف منها للمورد
    let activeOrdersList  = [];  // الطلبات التي أُرسل صنف واحد فأكثر للمورد
    let archivedOrdersList = []; // الطلبات المؤرشفة

    let cachedClients  = [];     // { id, name }
    let cachedProducts = [];     // { id, name }
    let cachedVariants = [];     // { id, product_id, size_name, selling_price }
    let suppliersList  = [];     // { id, company_name }

    // بيانات مؤقتة للمودالات
    let singleOrderPOItems = []; // أصناف نافذة تحويل طلب واحد
    let smartPOAllItems    = []; // أصناف نافذة الـ Smart PO
    let invoiceItemsTemp   = []; // أصناف نافذة الفاتورة
    let currentInvoicesList = [];// فواتير الأمر المفتوح حالياً

    // =====================================================================
    // تحميل الصفحة
    // =====================================================================
    window.onload = async () => {
        try {
            showLoading(true);
            await fetchBaseCache();   // clients + products + variants
            await fetchSuppliers();   // suppliers + ملء القوائم المنسدلة
            await fetchClientOrders();// orders + تصنيفها pending/active
            switchTab('pending_orders');
        } catch (err) {
            console.error('Critical Load Error:', err);
            alert('حدث خطأ أثناء تشغيل النظام، يرجى تحديث الصفحة.');
        } finally {
            showLoading(false);
        }
    };

    function showLoading(show) {
        const el = document.getElementById('loadingIndicator');
        show ? el.classList.remove('hidden') : el.classList.add('hidden');
    }

    // =====================================================================
    // الكاش: جلب البيانات الأساسية
    // =====================================================================
    async function fetchBaseCache() {
        const [clientsRes, productsRes, variantsRes] = await Promise.all([
            supabaseClient.from('clients').select('id, name'),
            supabaseClient.from('products').select('id, name'),
            supabaseClient.from('product_variants').select('id, product_id, size_name, selling_price')
        ]);
        if (clientsRes.data)  cachedClients  = clientsRes.data;
        if (productsRes.data) cachedProducts = productsRes.data;
        if (variantsRes.data) cachedVariants = variantsRes.data;
    }

    // =====================================================================
    // دوال المساعدة — ربط البيانات يدوياً من الكاش
    // =====================================================================
    function getClientName(clientId) {
        if (!clientId) return 'عميل نقدي / غير محدد';
        const c = cachedClients.find(x => x.id === clientId);
        return c ? c.name : 'عميل نقدي / غير محدد';
    }

    function getVariantDetails(variantId) {
        if (!variantId) return { name: 'صنف غير محدد', price: 0 };
        const v = cachedVariants.find(x => x.id === variantId);
        if (!v) return { name: 'صنف غير معروف', price: 0 };
        const p = cachedProducts.find(x => x.id === v.product_id);
        const pName = p ? p.name : 'منتج محذوف';
        const sizePart = v.size_name ? ` (${v.size_name})` : '';
        return {
            name: `${pName}${sizePart}`.trim(),
            price: v.selling_price || 0
        };
    }

    // =====================================================================
    // جلب الموردين وملء القوائم المنسدلة
    // =====================================================================
    async function fetchSuppliers() {
        const { data } = await supabaseClient.from('suppliers').select('id, company_name');
        suppliersList = data || [];

        const emptyOpt = '<option value="">-- اختر المطبعة / المورد --</option>';
        const options  = suppliersList.map(s => `<option value="${s.id}">${s.company_name}</option>`).join('');

        ['poSupplierSelect', 'singlePoSupplierSelect'].forEach(selId => {
            const el = document.getElementById(selId);
            if (el) el.innerHTML = emptyOpt + options;
        });
    }

    // =====================================================================
    // دوال الواجهة الأساسية
    // =====================================================================
    function toggleSidebar() {
        const sidebar  = document.getElementById('sidebar');
        const overlay  = document.getElementById('sidebarOverlay');
        if (window.innerWidth < 768) {
            sidebar.classList.toggle('sidebar-mobile-hidden');
            overlay.classList.toggle('hidden');
        } else {
            sidebar.classList.toggle('sidebar-collapsed');
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        const content = document.getElementById(`tab-${tabName}`);
        const btn     = document.getElementById(`tab-${tabName}-btn`);
        if (content) content.classList.remove('hidden');
        if (btn) btn.classList.add('active');

        if (tabName === 'pending_orders') renderPendingOrdersTable();
        if (tabName === 'client_orders')  filterClientOrders();
        if (tabName === 'supplier_pos')   fetchSupplierPOs();
        if (tabName === 'archive')        fetchArchivedOrders();
    }

    // =====================================================================
    // جلب وتصنيف الأوامر (pending / active)
    // =====================================================================
    async function fetchClientOrders() {
        showLoading(true);
        try {
            // جلب أوامر الإنتاج السارية فقط
            const { data: orders, error: ordersErr } = await supabaseClient
                .from('orders')
                .select('*')
                .eq('status', 'production')
                .order('created_at', { ascending: false });

            if (ordersErr) throw ordersErr;
            allOrdersList = orders || [];

            if (allOrdersList.length === 0) {
                pendingOrdersList = [];
                activeOrdersList  = [];
                renderPendingOrdersTable();
                filterClientOrders();
                return;
            }

            // جلب كل أصناف هذه الأوامر
            const orderIds = allOrdersList.map(o => o.id);
            const { data: allItems } = await supabaseClient
                .from('order_items')
                .select('id, order_id')
                .in('order_id', orderIds);

            const allItemIds = allItems ? allItems.map(i => i.id) : [];

            // جلب الأصناف التي أُرسلت لمورد فعلاً — مع دعم chunking للأرقام الكبيرة
            let orderedItemIds = [];
            if (allItemIds.length > 0) {
                const chunkSize = 500;
                for (let i = 0; i < allItemIds.length; i += chunkSize) {
                    const chunk = allItemIds.slice(i, i + chunkSize);
                    const { data: poItems } = await supabaseClient
                        .from('supplier_po_items')
                        .select('order_item_id')
                        .in('order_item_id', chunk);
                    if (poItems) orderedItemIds.push(...poItems.map(p => p.order_item_id));
                }
            }

            // تصنيف الأوامر بدقة
            pendingOrdersList = [];
            activeOrdersList  = [];

            allOrdersList.forEach(order => {
                const itemsForOrder = (allItems || []).filter(i => i.order_id === order.id);
                const hasSentItem   = itemsForOrder.some(i => orderedItemIds.includes(i.id));

                if (hasSentItem) {
                    activeOrdersList.push(order);
                } else {
                    pendingOrdersList.push(order);
                }
            });

            renderPendingOrdersTable();
            filterClientOrders();
        } catch (err) {
            console.error('fetchClientOrders Error:', err);
            alert('خطأ في جلب الأوامر: ' + err.message);
        } finally {
            showLoading(false);
        }
    }

    // =====================================================================
    // تابة: الطلبات المعلقة
    // =====================================================================
    function renderPendingOrdersTable() {
        const tbody = document.getElementById('pendingOrdersTable');
        tbody.innerHTML = '';

        if (pendingOrdersList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-gray-400"><i class="fas fa-check-circle text-green-400 text-2xl mb-2 block"></i>لا توجد طلبات معلقة — كل شيء قيد التشغيل</td></tr>';
            return;
        }

        pendingOrdersList.forEach(o => {
            const clientName = getClientName(o.client_id);
            const dateStr    = new Date(o.created_at).toLocaleDateString('ar-EG');
            tbody.innerHTML += `
                <tr class="border-b hover:bg-orange-50 transition">
                    <td class="p-3 font-bold text-orange-700 serial-num">#${o.order_number}</td>
                    <td class="p-3 text-sm text-gray-600">${dateStr}</td>
                    <td class="p-3 font-bold text-gray-800">${clientName}</td>
                    <td class="p-3 text-center">
                        <button onclick="openSingleOrderPOModal('${o.id}')"
                            class="bg-orange-100 text-orange-700 hover:bg-orange-600 hover:text-white px-4 py-1.5 rounded-full text-xs font-bold transition border border-orange-300 flex items-center gap-1 mx-auto">
                            <i class="fas fa-cogs"></i> تحويل للإنتاج
                        </button>
                    </td>
                </tr>`;
        });
    }

    // =====================================================================
    // تابة: الأوامر السارية
    // =====================================================================
    function filterClientOrders() {
        const term    = (document.getElementById('searchClientOrders')?.value || '').toLowerCase();
        const sort    = document.getElementById('sortClientOrders')?.value || 'newest';
        const statusF = document.getElementById('statusClientOrders')?.value || 'all';

        let filtered = [...activeOrdersList];

        if (term) {
            filtered = filtered.filter(o => {
                const cName = getClientName(o.client_id).toLowerCase();
                return cName.includes(term) || (o.order_number && String(o.order_number).includes(term));
            });
        }

        if (statusF !== 'all') {
            filtered = filtered.filter(o => {
                const paid = parseFloat(o.paid_amount) || 0;
                const rem  = (parseFloat(o.grand_total) || 0) - paid;
                if (statusF === 'paid') return rem <= 0;
                if (statusF === 'debt') return rem > 0;
                return true;
            });
        }

        filtered.sort((a, b) => {
            const da = new Date(a.created_at);
            const db = new Date(b.created_at);
            return sort === 'newest' ? db - da : da - db;
        });

        renderClientOrdersTable(filtered);
    }

    function renderClientOrdersTable(orders) {
        const tbody = document.getElementById('clientOrdersTable');
        tbody.innerHTML = '';

        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">لا توجد أوامر تشغيل سارية</td></tr>';
            return;
        }

        orders.forEach(o => {
            const paid       = parseFloat(o.paid_amount) || 0;
            const total      = parseFloat(o.grand_total) || 0;
            const remaining  = total - paid;
            const clientName = getClientName(o.client_id);
            const dateStr    = new Date(o.created_at).toLocaleDateString('ar-EG');

            const paidBadge  = remaining <= 0
                ? '<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold">خالص مالياً</span>'
                : '<span class="bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs font-bold">متبقي دفعة</span>';

            tbody.innerHTML += `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="p-3 font-bold text-purple-800 serial-num">#${o.order_number}</td>
                    <td class="p-3 text-sm text-gray-600">${dateStr}</td>
                    <td class="p-3 font-bold">${clientName}</td>
                    <td class="p-3 font-mono">${total.toFixed(2)}</td>
                    <td class="p-3 text-green-700 font-bold font-mono">${paid.toFixed(2)}</td>
                    <td class="p-3 text-red-700 font-bold font-mono">${remaining > 0 ? remaining.toFixed(2) : '0.00'}</td>
                    <td class="p-3 text-center">
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold">قيد التشغيل</span>
                        ${paidBadge}
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="manageOrder('${o.id}', '${o.client_id}')"
                            class="bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white px-4 py-1 rounded-full text-xs font-bold transition border border-blue-200">
                            إدارة الأمر
                        </button>
                    </td>
                </tr>`;
        });
    }

    // =====================================================================
    // تابة: الأرشيف
    // =====================================================================
    async function fetchArchivedOrders() {
        const tbody = document.getElementById('archivedOrdersTable');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-400"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';

        try {
            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .eq('status', 'archived')
                .order('created_at', { ascending: false });

            if (error) throw error;
            archivedOrdersList = data || [];
            tbody.innerHTML = '';

            if (archivedOrdersList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">لا توجد أوامر مؤرشفة</td></tr>';
                return;
            }

            archivedOrdersList.forEach(o => {
                const clientName = getClientName(o.client_id);
                const dateStr    = new Date(o.created_at).toLocaleDateString('ar-EG');
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-3 font-bold text-gray-600 serial-num">#${o.order_number}</td>
                        <td class="p-3 text-sm text-gray-500">${dateStr}</td>
                        <td class="p-3 font-bold text-gray-700">${clientName}</td>
                        <td class="p-3 font-mono text-gray-700">${(parseFloat(o.grand_total) || 0).toFixed(2)}</td>
                        <td class="p-3 text-center">
                            <button onclick="manageOrder('${o.id}', '${o.client_id}')"
                                class="bg-gray-100 text-gray-600 hover:bg-gray-600 hover:text-white px-4 py-1 rounded-full text-xs font-bold transition border border-gray-300">
                                <i class="fas fa-eye"></i> عرض
                            </button>
                        </td>
                    </tr>`;
            });
        } catch (err) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">خطأ في تحميل الأرشيف: ' + err.message + '</td></tr>';
        }
    }

    // =====================================================================
    // نافذة: تحويل طلب واحد للإنتاج
    // =====================================================================
    async function openSingleOrderPOModal(orderId) {
        // إعادة تعيين الحقول
        document.getElementById('singlePoSupplierSelect').value = '';
        document.getElementById('singlePoExpectedDate').value = '';
        const selectAllCheck = document.getElementById('selectAllSinglePoItems');
        if (selectAllCheck) selectAllCheck.checked = false;

        const tbody = document.getElementById('singlePoAvailableItemsBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-400"><i class="fas fa-spinner fa-spin"></i> جاري جلب الأصناف...</td></tr>';
        openModal('singleOrderPOModal');

        try {
            // جلب أصناف هذا الطلب
            const { data: items, error: itemsErr } = await supabaseClient
                .from('order_items')
                .select('*')
                .eq('order_id', orderId);

            if (itemsErr) throw itemsErr;

            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-500 font-bold">لا توجد أصناف لهذا الطلب.</td></tr>';
                return;
            }

            // تحديد الأصناف التي أُرسلت بالفعل
            const itemIds = items.map(i => i.id);
            const { data: poItemsData } = await supabaseClient
                .from('supplier_po_items')
                .select('order_item_id')
                .in('order_item_id', itemIds);

            const orderedItemIds = poItemsData ? poItemsData.map(i => i.order_item_id) : [];

            // تصفية الأصناف المتاحة (غير المرسلة)
            singleOrderPOItems = items.filter(item => !orderedItemIds.includes(item.id));

            if (singleOrderPOItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-green-600 font-bold"><i class="fas fa-check-circle"></i> تم إرسال جميع أصناف هذا الطلب للموردين.</td></tr>';
                return;
            }

            // ربط بيانات الكاش بكل صنف
            const orderData  = allOrdersList.find(o => o.id === orderId);
            const clientName = getClientName(orderData?.client_id);

            tbody.innerHTML = '';
            singleOrderPOItems.forEach((item, idx) => {
                const varDetails = getVariantDetails(item.variant_id);
                // تخزين اسم الصنف والعميل في الكاش المحلي لاستخدامه وقت الإرسال
                singleOrderPOItems[idx]._cachedName   = varDetails.name;
                singleOrderPOItems[idx]._cachedClient = clientName;

                const priceBadge = varDetails.price > 0
                    ? `<span class="font-mono text-blue-700 font-bold">${varDetails.price.toFixed(2)}</span>`
                    : '<span class="text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">أول توريد</span>';

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-orange-50/30 transition">
                        <td class="p-3 text-center">
                            <input type="checkbox" class="single-po-item-checkbox w-4 h-4 text-orange-600 rounded" value="${idx}">
                        </td>
                        <td class="p-3 font-bold">${varDetails.name}</td>
                        <td class="p-3 font-mono font-bold text-lg text-center">${item.quantity}</td>
                        <td class="p-3 text-center">${priceBadge}</td>
                        <td class="p-3">
                            <select id="singleDesignStatus_${idx}" class="input-std text-xs bg-white border-red-200 focus:border-red-500">
                                <option value="">-- حدد الحالة --</option>
                                <option value="new_design">تصميم جديد</option>
                                <option value="reprint">إعادة طباعة</option>
                            </select>
                        </td>
                        <td class="p-3">
                            <input type="text" id="singlePoNotes_${idx}" class="input-std text-xs" placeholder="ملاحظات..">
                        </td>
                    </tr>`;
            });
        } catch (err) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-500">حدث خطأ أثناء تحميل الأصناف.</td></tr>';
            console.error('openSingleOrderPOModal Error:', err);
        }
    }

    function toggleAllSinglePoItems(el) {
        document.querySelectorAll('.single-po-item-checkbox').forEach(cb => cb.checked = el.checked);
    }

    async function submitSingleSupplierPO() {
        const supplierId   = document.getElementById('singlePoSupplierSelect').value;
        const expectedDate = document.getElementById('singlePoExpectedDate').value;
        const printToggle  = document.getElementById('singlePoPrintPriceToggle').value;

        if (!supplierId) return alert('الرجاء اختيار المورد');

        const checkboxes = document.querySelectorAll('.single-po-item-checkbox:checked');
        if (checkboxes.length === 0) return alert('يرجى تحديد صنف واحد على الأقل للإنتاج');

        let selectedItemsPayload = [];
        let validationFailed     = false;

        checkboxes.forEach(cb => {
            const idx         = parseInt(cb.value);
            const itemData    = singleOrderPOItems[idx];
            const designStatus = document.getElementById(`singleDesignStatus_${idx}`).value;
            const notes       = document.getElementById(`singlePoNotes_${idx}`).value;
            if (!designStatus) validationFailed = true;

            selectedItemsPayload.push({
                order_item_id: itemData.id,
                design_status: designStatus,
                notes: notes,
                _meta: {
                    product: itemData._cachedName,
                    client:  itemData._cachedClient,
                    qty:     itemData.quantity,
                    price:   itemData.unit_price || 0
                }
            });
        });

        if (validationFailed) return alert('الحالة التصنيعية إلزامية لجميع الأصناف المحددة!');

        const btn = document.getElementById('btnSubmitSinglePO');
        btn.disabled  = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';

        try {
            // توليد رقم PO فريد
            const { count } = await supabaseClient
                .from('supplier_production_orders')
                .select('*', { count: 'exact', head: true });
            const year  = new Date().getFullYear().toString().substr(-2);
            const poNum = `${String((count || 0) + 1).padStart(4, '0')}-PO-300${year}`;

            // إنشاء رأس الأمر
            const { data: poData, error: poErr } = await supabaseClient
                .from('supplier_production_orders')
                .insert([{
                    supplier_id:            supplierId,
                    po_number:              poNum,
                    expected_delivery_date: expectedDate || null,
                    status:                 'pending'
                }])
                .select()
                .single();

            if (poErr) throw poErr;

            // إدخال تفاصيل الأصناف
            const itemsToInsert = selectedItemsPayload.map(i => ({
                supplier_po_id: poData.id,
                order_item_id:  i.order_item_id,
                design_status:  i.design_status,
                notes:          i.notes
            }));
            const { error: insErr } = await supabaseClient
                .from('supplier_po_items')
                .insert(itemsToInsert);
            if (insErr) throw insErr;

            // إغلاق المودال أولاً ثم تحديث البيانات — يضمن الانتقال الفوري
            closeModal('singleOrderPOModal');
            await fetchClientOrders();   // تحديث قسري للكاش
            switchTab('client_orders');  // الانتقال للتابة السارية

            alert('تم تحويل الطلب للإنتاج بنجاح!');
            buildAndPrintPO(poData, selectedItemsPayload, printToggle, supplierId);

        } catch (err) {
            alert('خطأ أثناء الحفظ: ' + err.message);
            console.error('submitSingleSupplierPO Error:', err);
        } finally {
            btn.disabled  = false;
            btn.innerHTML = 'حفظ وإنشاء أمر طباعة المورد';
        }
    }

    // =====================================================================
    // نافذة: أمر إنتاج تجميعي (Smart PO)
    // =====================================================================
    async function openSmartPOModal() {
        document.getElementById('poSupplierSelect').value = '';
        document.getElementById('poExpectedDate').value   = '';
        const selectAll = document.getElementById('selectAllPoItems');
        if (selectAll) selectAll.checked = false;

        const tbody = document.getElementById('poAvailableItemsBody');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-400"><i class="fas fa-spinner fa-spin"></i> جاري جلب الأصناف المتاحة...</td></tr>';
        openModal('smartPOModal');

        try {
            if (pendingOrdersList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-green-600 font-bold"><i class="fas fa-check-circle"></i> لا توجد أصناف معلقة — جميع الطلبات قيد التصنيع.</td></tr>';
                smartPOAllItems = [];
                return;
            }

            // جلب أصناف كل الطلبات المعلقة
            const pendingOrderIds = pendingOrdersList.map(o => o.id);
            const { data: items, error: itemsErr } = await supabaseClient
                .from('order_items')
                .select('*')
                .in('order_id', pendingOrderIds);

            if (itemsErr) throw itemsErr;

            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-400">لا توجد أصناف متاحة.</td></tr>';
                smartPOAllItems = [];
                return;
            }

            // تحقق من الأصناف المرسلة بالفعل
            const itemIds = items.map(i => i.id);
            const { data: poItemsData } = await supabaseClient
                .from('supplier_po_items')
                .select('order_item_id')
                .in('order_item_id', itemIds);
            const orderedItemIds = poItemsData ? poItemsData.map(x => x.order_item_id) : [];

            // تصفية الأصناف المتاحة فقط
            smartPOAllItems = items
                .filter(item => !orderedItemIds.includes(item.id))
                .map(item => {
                    const varDetails  = getVariantDetails(item.variant_id);
                    const parentOrder = pendingOrdersList.find(o => o.id === item.order_id);
                    const clientName  = getClientName(parentOrder?.client_id);
                    const orderNum    = parentOrder ? `#${parentOrder.order_number}` : '-';
                    return {
                        ...item,
                        _cachedName:    varDetails.name,
                        _cachedClient:  clientName,
                        _cachedOrderNum: orderNum,
                        _cachedPrice:   varDetails.price
                    };
                });

            if (smartPOAllItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-green-600 font-bold">لا توجد أصناف متاحة حالياً.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            smartPOAllItems.forEach((item, idx) => {
                const priceBadge = item._cachedPrice > 0
                    ? `<span class="font-mono text-blue-700 font-bold">${item._cachedPrice.toFixed(2)}</span>`
                    : '<span class="text-xs text-red-500 bg-red-50 px-2 py-1 rounded font-bold">أول توريد</span>';

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-yellow-50/30 transition">
                        <td class="p-3 text-center">
                            <input type="checkbox" class="smart-po-item-checkbox w-4 h-4 text-purple-600 rounded" value="${idx}">
                        </td>
                        <td class="p-3 text-purple-800 font-bold serial-num">${item._cachedOrderNum}</td>
                        <td class="p-3 text-sm font-bold">${item._cachedName} <span class="text-xs text-gray-400 font-normal">(${item._cachedClient})</span></td>
                        <td class="p-3 font-mono font-bold text-center">${item.quantity}</td>
                        <td class="p-3 text-center">${priceBadge}</td>
                        <td class="p-3">
                            <select id="smartDesignStatus_${idx}" class="input-std text-xs bg-white border-red-200 focus:border-red-500">
                                <option value="">-- حدد الحالة --</option>
                                <option value="new_design">تصميم جديد</option>
                                <option value="reprint">إعادة طباعة</option>
                            </select>
                        </td>
                        <td class="p-3">
                            <input type="text" id="smartPoNotes_${idx}" class="input-std text-xs" placeholder="ملاحظات..">
                        </td>
                    </tr>`;
            });
        } catch (err) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-red-500">حدث خطأ أثناء تحميل الأصناف.</td></tr>';
            console.error('openSmartPOModal Error:', err);
        }
    }

    function toggleAllPoItems(el) {
        document.querySelectorAll('.smart-po-item-checkbox').forEach(cb => cb.checked = el.checked);
    }

    async function submitSupplierPO() {
        const supplierId   = document.getElementById('poSupplierSelect').value;
        const expectedDate = document.getElementById('poExpectedDate').value;
        const printToggle  = document.getElementById('poPrintPriceToggle').value;

        if (!supplierId) return alert('الرجاء اختيار المورد');

        const checkboxes = document.querySelectorAll('.smart-po-item-checkbox:checked');
        if (checkboxes.length === 0) return alert('يرجى تحديد صنف واحد على الأقل');

        let selectedItemsPayload = [];
        let validationFailed     = false;

        checkboxes.forEach(cb => {
            const idx         = parseInt(cb.value);
            const itemData    = smartPOAllItems[idx];
            const designStatus = document.getElementById(`smartDesignStatus_${idx}`).value;
            const notes       = document.getElementById(`smartPoNotes_${idx}`).value;
            if (!designStatus) validationFailed = true;

            selectedItemsPayload.push({
                order_item_id: itemData.id,
                design_status: designStatus,
                notes: notes,
                _meta: {
                    product: itemData._cachedName,
                    client:  itemData._cachedClient,
                    qty:     itemData.quantity,
                    price:   itemData._cachedPrice || 0
                }
            });
        });

        if (validationFailed) return alert('الحالة التصنيعية إلزامية لجميع الأصناف المحددة!');

        const btn = document.getElementById('btnSubmitSmartPO');
        btn.disabled  = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';

        try {
            const { count } = await supabaseClient
                .from('supplier_production_orders')
                .select('*', { count: 'exact', head: true });
            const year  = new Date().getFullYear().toString().substr(-2);
            const poNum = `${String((count || 0) + 1).padStart(4, '0')}-PO-300${year}`;

            const { data: poData, error: poErr } = await supabaseClient
                .from('supplier_production_orders')
                .insert([{
                    supplier_id:            supplierId,
                    po_number:              poNum,
                    expected_delivery_date: expectedDate || null,
                    status:                 'pending'
                }])
                .select()
                .single();

            if (poErr) throw poErr;

            const itemsToInsert = selectedItemsPayload.map(i => ({
                supplier_po_id: poData.id,
                order_item_id:  i.order_item_id,
                design_status:  i.design_status,
                notes:          i.notes
            }));
            const { error: insErr } = await supabaseClient
                .from('supplier_po_items')
                .insert(itemsToInsert);
            if (insErr) throw insErr;

            closeModal('smartPOModal');
            await fetchClientOrders();
            switchTab('client_orders');

            alert('تم إنشاء أمر الإنتاج المجمع بنجاح!');
            buildAndPrintPO(poData, selectedItemsPayload, printToggle, supplierId);

        } catch (err) {
            alert('خطأ أثناء الحفظ: ' + err.message);
            console.error('submitSupplierPO Error:', err);
        } finally {
            btn.disabled  = false;
            btn.innerHTML = 'حفظ وإنشاء أمر الطباعة';
        }
    }

    // =====================================================================
    // تابة: أوامر الموردين
    // =====================================================================
    async function fetchSupplierPOs() {
        const tbody = document.getElementById('supplierPOTable');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-gray-400"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';

        try {
            const { data, error } = await supabaseClient
                .from('supplier_production_orders')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">لا توجد أوامر موردين</td></tr>';
                return;
            }

            data.forEach(po => {
                const supp     = suppliersList.find(s => s.id === po.supplier_id);
                const suppName = supp ? supp.company_name : 'مورد غير معروف';
                const isCompleted = po.status === 'completed';
                const statusBadge = isCompleted
                    ? '<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold"><i class="fas fa-check"></i> تم الاستلام</span>'
                    : '<span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold">قيد التصنيع</span>';
                const receiveBtn = isCompleted
                    ? ''
                    : `<button onclick="openReceivePOModal('${po.id}')"
                            class="text-green-600 hover:text-white hover:bg-green-600 font-bold text-xs bg-green-50 px-3 py-1 rounded border border-green-200 transition"
                            title="استلام بضاعة"><i class="fas fa-box-open"></i> استلام</button>`;

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-blue-50/30 transition">
                        <td class="p-3 font-bold text-blue-800 serial-num">${po.po_number}</td>
                        <td class="p-3 text-sm text-gray-600">${new Date(po.created_at).toLocaleDateString('ar-EG')}</td>
                        <td class="p-3 font-bold">${suppName}</td>
                        <td class="p-3 text-red-600 text-sm font-bold">${po.expected_delivery_date || '-'}</td>
                        <td class="p-3">${statusBadge}</td>
                        <td class="p-3 text-center">
                            <div class="flex justify-center items-center gap-2">
                                <button onclick="viewPODetails('${po.id}')"
                                    class="text-blue-500 hover:text-blue-700 bg-blue-50 px-2 py-1 rounded border text-xs" title="عرض التفاصيل">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${receiveBtn}
                                <button onclick="reprintSupplierPO('${po.id}')"
                                    class="text-gray-500 hover:text-purple-600 bg-gray-100 px-3 py-1 rounded border hover:bg-purple-50 transition text-xs" title="طباعة الأمر">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });
        } catch (err) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">خطأ في التحميل: ' + err.message + '</td></tr>';
        }
    }

    async function viewPODetails(poId) {
        const tbody = document.getElementById('poDetailsModalBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';
        openModal('poDetailsModal');

        try {
            const { data: po } = await supabaseClient
                .from('supplier_production_orders')
                .select('po_number')
                .eq('id', poId)
                .single();
            document.getElementById('viewPoNum').innerText = po ? po.po_number : '';

            const { data: poItems } = await supabaseClient
                .from('supplier_po_items')
                .select('*')
                .eq('supplier_po_id', poId);

            if (!poItems || poItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">لا توجد تفاصيل لهذا الأمر</td></tr>';
                return;
            }

            const itemIds = poItems.map(i => i.order_item_id);
            const { data: orderItems } = await supabaseClient
                .from('order_items')
                .select('*')
                .in('id', itemIds);

            tbody.innerHTML = '';
            poItems.forEach(i => {
                const oi = (orderItems || []).find(x => x.id === i.order_item_id);
                if (!oi) return;

                const varDetails  = getVariantDetails(oi.variant_id);
                const parentOrder = allOrdersList.find(o => o.id === oi.order_id);
                const clientName  = parentOrder ? getClientName(parentOrder.client_id) : 'غير معروف';
                const dsText = i.design_status === 'new_design'
                    ? '<span class="text-red-600 font-bold text-xs">تصميم جديد</span>'
                    : '<span class="text-blue-600 font-bold text-xs">إعادة طباعة</span>';

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2 font-bold text-xs">${clientName}</td>
                        <td class="p-2 text-sm">${varDetails.name}</td>
                        <td class="p-2 text-center font-bold font-mono">${oi.quantity}</td>
                        <td class="p-2">${dsText}</td>
                        <td class="p-2 text-xs text-gray-500">${i.notes || '-'}</td>
                    </tr>`;
            });
        } catch (err) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">حدث خطأ في الجلب.</td></tr>';
            console.error('viewPODetails Error:', err);
        }
    }

    // =====================================================================
    // الاستلام المخزني
    // =====================================================================
    async function openReceivePOModal(poId) {
        document.getElementById('receivePoId').value = poId;
        document.getElementById('markPoCompleted').checked = false;
        const tbody = document.getElementById('receivePOItemsBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> جاري جلب البضاعة...</td></tr>';
        openModal('receivePOModal');

        try {
            const { data: poData } = await supabaseClient
                .from('supplier_production_orders')
                .select('supplier_id')
                .eq('id', poId)
                .single();
            document.getElementById('receiveSupplierId').value = poData ? poData.supplier_id : '';

            const { data: poItems } = await supabaseClient
                .from('supplier_po_items')
                .select('*')
                .eq('supplier_po_id', poId);

            if (!poItems || poItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">لا توجد بضاعة للاستلام</td></tr>';
                return;
            }

            const itemIds = poItems.map(i => i.order_item_id);
            const { data: orderItems } = await supabaseClient
                .from('order_items')
                .select('*')
                .in('id', itemIds);

            tbody.innerHTML = '';
            poItems.forEach(i => {
                const oi = (orderItems || []).find(x => x.id === i.order_item_id);
                if (!oi) return;

                const varDetails  = getVariantDetails(oi.variant_id);
                const parentOrder = allOrdersList.find(o => o.id === oi.order_id);
                const clientName  = parentOrder ? getClientName(parentOrder.client_id) : 'غير معروف';
                const clientId    = parentOrder ? parentOrder.client_id : null;

                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2 font-bold text-xs">${clientName}</td>
                        <td class="p-2 text-xs font-bold">${varDetails.name}</td>
                        <td class="p-2 text-center font-bold text-gray-500">${oi.quantity}</td>
                        <td class="p-2 text-center bg-green-50">
                            <input type="number" id="recQty_${i.id}" value="${oi.quantity}" min="0" max="${oi.quantity}"
                                class="w-20 border rounded p-1 text-center font-bold text-green-700"
                                data-var="${oi.variant_id}" data-client="${clientId}" data-price="${oi.unit_price || 0}">
                        </td>
                        <td class="p-2 text-center text-xs text-gray-500">${oi.unit_price || 0}</td>
                    </tr>`;
            });
        } catch (err) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">حدث خطأ.</td></tr>';
            console.error('openReceivePOModal Error:', err);
        }
    }

    async function submitReceivePO() {
        const poId        = document.getElementById('receivePoId').value;
        const supplierId  = document.getElementById('receiveSupplierId').value;
        const isCompleted = document.getElementById('markPoCompleted').checked;
        const inputs      = document.querySelectorAll('input[id^="recQty_"]');

        const btn = document.getElementById('btnConfirmReceive');
        btn.disabled  = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الاستلام...';

        try {
            const { data: wh } = await supabaseClient.from('warehouses').select('id').limit(1).single();
            const defaultWhId  = wh ? wh.id : null;

            let totalInvoiceAmount = 0;
            let receivedSomething  = false;

            for (const inp of inputs) {
                const qty   = parseInt(inp.value) || 0;
                if (qty <= 0) continue;

                receivedSomething = true;
                const varId  = inp.getAttribute('data-var');
                const cId    = inp.getAttribute('data-client') !== 'null' ? inp.getAttribute('data-client') : null;
                const price  = parseFloat(inp.getAttribute('data-price')) || 0;
                totalInvoiceAmount += qty * price;

                // تحديث المخزون
                const { data: stock } = await supabaseClient
                    .from('warehouse_stock')
                    .select('*')
                    .eq('warehouse_id', defaultWhId)
                    .eq('variant_id', varId)
                    .eq('client_id', cId)
                    .single()
                    .catch(() => ({ data: null }));

                if (stock) {
                    await supabaseClient.from('warehouse_stock').update({ quantity: stock.quantity + qty }).eq('id', stock.id);
                } else {
                    await supabaseClient.from('warehouse_stock').insert([{ warehouse_id: defaultWhId, variant_id: varId, client_id: cId, quantity: qty }]);
                }

                await supabaseClient.from('inventory_transactions').insert([{
                    warehouse_to:     defaultWhId,
                    variant_id:       varId,
                    client_id:        cId,
                    quantity:         qty,
                    transaction_type: 'supply',
                    delivery_status:  'delivered',
                    notes:            'استلام بضاعة مورد'
                }]);
            }

            if (!receivedSomething) {
                return alert('الرجاء إدخال كمية لواحد من الأصناف على الأقل.');
            }

            if (totalInvoiceAmount > 0) {
                const docNum = `PINV-${Date.now().toString().slice(-6)}`;
                await supabaseClient.from('supplier_transactions').insert([{
                    supplier_id:     supplierId,
                    type:            'invoice',
                    amount:          totalInvoiceAmount,
                    description:     'استلام آلي من طلب إنتاج',
                    document_number: docNum,
                    warehouse_id:    defaultWhId,
                    is_taxable:      false
                }]);
            }

            if (isCompleted) {
                await supabaseClient.from('supplier_production_orders').update({ status: 'completed' }).eq('id', poId);
            }

            alert('تم استلام الكميات المُدخلة للمخزن بنجاح.');
            closeModal('receivePOModal');
            fetchSupplierPOs();
        } catch (err) {
            alert('خطأ أثناء الاستلام: ' + err.message);
            console.error('submitReceivePO Error:', err);
        } finally {
            btn.disabled  = false;
            btn.innerHTML = 'تأكيد الاستلام وإنشاء الفاتورة';
        }
    }

    // =====================================================================
    // نافذة إدارة الأمر
    // =====================================================================
    async function manageOrder(orderId, clientId) {
        document.getElementById('mgrActiveOrderId').value  = orderId;
        document.getElementById('mgrActiveClientId').value = clientId;

        // استخدام الكاش أولاً — البحث في كل القوائم
        const order = allOrdersList.find(o => o.id === orderId)
                   || archivedOrdersList.find(o => o.id === orderId);

        if (order) {
            document.getElementById('mgrOrderNum').innerText   = `#${order.order_number}`;
            document.getElementById('mgrClientName').innerText = getClientName(order.client_id);
            document.getElementById('invAdvancePayment').value = parseFloat(order.paid_amount) || 0;
        }

        switchMgrTab('items');
        openModal('orderManagerModal');

        const tbody   = document.getElementById('mgrItemsBody');
        const table   = document.getElementById('mgrItemsTable');
        const loading = document.getElementById('mgrItemsLoading');
        table.classList.add('hidden');
        loading.classList.remove('hidden');
        tbody.innerHTML = '';

        try {
            const { data: items } = await supabaseClient
                .from('order_items')
                .select('*')
                .eq('order_id', orderId);

            loading.classList.add('hidden');

            if (items && items.length > 0) {
                items.forEach(i => {
                    const varDetails = getVariantDetails(i.variant_id);
                    const total      = (i.quantity || 0) * (i.unit_price || 0);
                    tbody.innerHTML += `
                        <tr>
                            <td class="p-2 font-bold">${varDetails.name}</td>
                            <td class="p-2 text-center font-mono">${i.quantity}</td>
                            <td class="p-2 text-center">${i.unit_price || 0}</td>
                            <td class="p-2 text-center text-purple-700 font-bold">${total.toFixed(2)}</td>
                        </tr>`;
                });
                table.classList.remove('hidden');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">لا توجد أصناف</td></tr>';
                table.classList.remove('hidden');
            }
        } catch (err) {
            loading.classList.add('hidden');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">خطأ في التحميل.</td></tr>';
            table.classList.remove('hidden');
        }

        fetchClientInvoices(orderId);
        fetchDeliveriesLog(clientId);
    }

    function switchMgrTab(tabName) {
        ['items', 'invoices', 'deliveries'].forEach(t => {
            const el = document.getElementById(`mgr-content-${t}`);
            const btn = document.getElementById(`mgr-tab-${t}`);
            if (el) { el.classList.remove('block'); el.classList.add('hidden'); }
            if (btn) btn.classList.remove('active');
        });
        const activeEl  = document.getElementById(`mgr-content-${tabName}`);
        const activeBtn = document.getElementById(`mgr-tab-${tabName}`);
        if (activeEl) { activeEl.classList.remove('hidden'); activeEl.classList.add('block'); }
        if (activeBtn) activeBtn.classList.add('active');
    }

    // =====================================================================
    // الفواتير
    // =====================================================================
    async function openInvoiceModal(type) {
        document.getElementById('invModalType').value = type;
        document.getElementById('invoiceModalTitle').innerText = type === 'proforma'
            ? 'إصدار فاتورة أولية (مالية)'
            : 'إصدار فاتورة مبيعات (خصم من المخزون)';

        const orderId = document.getElementById('mgrActiveOrderId').value;
        const { data: items } = await supabaseClient
            .from('order_items')
            .select('*')
            .eq('order_id', orderId);

        invoiceItemsTemp = (items || []).map(item => {
            const varDetails = getVariantDetails(item.variant_id);
            return { ...item, fullName: varDetails.name }; // تأمين الاسم من الكاش
        });

        const tbody = document.getElementById('invoiceItemsBody');
        tbody.innerHTML = '';

        invoiceItemsTemp.forEach((item, idx) => {
            tbody.innerHTML += `
                <tr>
                    <td class="p-2 font-bold text-xs">${item.fullName}</td>
                    <td class="p-2 text-center">
                        <input type="number" id="invQty_${idx}" value="${item.quantity}" min="0"
                            class="w-20 border rounded p-1 text-center font-bold" oninput="calcInvRow(${idx})">
                    </td>
                    <td class="p-2 text-center">
                        <input type="number" id="invPrice_${idx}" value="${item.unit_price || 0}" min="0" step="0.01"
                            class="w-20 border rounded p-1 text-center" oninput="calcInvRow(${idx})">
                    </td>
                    <td class="p-2 text-center text-purple-700 font-bold" id="invTotal_${idx}">
                        ${((item.quantity || 0) * (item.unit_price || 0)).toFixed(2)}
                    </td>
                </tr>`;
        });
        calcInvTotal();
        openModal('invoiceModal');
    }

    function calcInvRow(idx) {
        const q = parseFloat(document.getElementById(`invQty_${idx}`)?.value) || 0;
        const p = parseFloat(document.getElementById(`invPrice_${idx}`)?.value) || 0;
        const el = document.getElementById(`invTotal_${idx}`);
        if (el) el.innerText = (q * p).toFixed(2);
        calcInvTotal();
    }

    function calcInvTotal() {
        let sub = 0;
        invoiceItemsTemp.forEach((_, idx) => {
            sub += parseFloat(document.getElementById(`invTotal_${idx}`)?.innerText || '0');
        });
        const tax     = sub * 0.15;
        const grand   = sub + tax;
        const advance = parseFloat(document.getElementById('invAdvancePayment').value) || 0;
        const rem     = grand - advance;

        document.getElementById('invoiceTotalVal').innerText   = grand.toFixed(2);
        document.getElementById('invoiceAdvanceVal').innerText = advance.toFixed(2);
        document.getElementById('invoiceRemainingVal').innerText = (rem > 0 ? rem : 0).toFixed(2);
    }

    async function submitInvoice() {
        const type     = document.getElementById('invModalType').value;
        const orderId  = document.getElementById('mgrActiveOrderId').value;
        const clientId = document.getElementById('mgrActiveClientId').value;

        const finalTotal = parseFloat(document.getElementById('invoiceTotalVal').innerText);
        let finalItems   = [];

        for (let i = 0; i < invoiceItemsTemp.length; i++) {
            const qty   = parseFloat(document.getElementById(`invQty_${i}`).value) || 0;
            const price = parseFloat(document.getElementById(`invPrice_${i}`).value) || 0;
            if (qty > 0) {
                finalItems.push({
                    variant_id: invoiceItemsTemp[i].variant_id,
                    name:       invoiceItemsTemp[i].fullName, // الاسم مضمون من الكاش
                    qty:        qty,
                    price:      price
                });
            }
        }

        if (type === 'final') {
            for (const item of finalItems) {
                const { data: stock } = await supabaseClient
                    .from('warehouse_stock')
                    .select('*')
                    .eq('variant_id', item.variant_id)
                    .eq('client_id', clientId)
                    .limit(1)
                    .single()
                    .catch(() => ({ data: null }));

                if (stock && stock.quantity >= item.qty) {
                    await supabaseClient.from('warehouse_stock').update({ quantity: stock.quantity - item.qty }).eq('id', stock.id);
                    await supabaseClient.from('inventory_transactions').insert([{
                        variant_id: item.variant_id, client_id: clientId, quantity: item.qty,
                        transaction_type: 'dispense', delivery_status: 'pending', notes: 'خصم فاتورة مبيعات'
                    }]);
                } else {
                    return alert(`تنبيه: الرصيد المخزني لا يكفي لخصم الكمية المطلوبة من الصنف: ${item.name}!\nيرجى استلام البضاعة من المورد أولاً.`);
                }
            }
        }

        const prefix  = type === 'proforma' ? 'PRO' : 'INV';
        const invNum  = `${prefix}-${Date.now().toString().slice(-6)}`;
        const advance = parseFloat(document.getElementById('invAdvancePayment').value) || 0;

        await supabaseClient.from('client_invoices').insert([{
            order_id:      orderId,
            client_id:     clientId,
            invoice_type:  type,
            invoice_number: invNum,
            total_amount:  finalTotal,
            down_payment:  advance,
            items_snapshot: finalItems
        }]);

        alert('تم الإصدار بنجاح!');
        closeModal('invoiceModal');
        fetchClientInvoices(orderId);
    }

    async function fetchClientInvoices(orderId) {
        const tbody = document.getElementById('mgrInvoicesBody');
        tbody.innerHTML = '';

        const { data } = await supabaseClient
            .from('client_invoices')
            .select('*')
            .eq('order_id', orderId)
            .order('created_at', { ascending: false });

        currentInvoicesList = data || [];

        if (data && data.length > 0) {
            data.forEach(inv => {
                const typeAr = inv.invoice_type === 'proforma'
                    ? '<span class="text-blue-600 bg-blue-50 px-2 rounded text-xs">أولية (مالية)</span>'
                    : '<span class="text-purple-600 bg-purple-50 px-2 rounded text-xs">مبيعات (نهائية)</span>';
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2 text-sm">${new Date(inv.created_at).toLocaleDateString('ar-EG')}</td>
                        <td class="p-2 font-mono text-xs">${inv.invoice_number}</td>
                        <td class="p-2">${typeAr}</td>
                        <td class="p-2 font-bold">${(parseFloat(inv.total_amount) || 0).toFixed(2)}</td>
                        <td class="p-2 text-center">
                            <button onclick="printClientInvoice('${inv.id}')"
                                class="text-gray-500 hover:text-purple-600 p-1 border rounded bg-white" title="طباعة">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-400">لا توجد فواتير مصدرة</td></tr>';
        }
    }

    function printClientInvoice(invId) {
        const invData = currentInvoicesList.find(i => i.id === invId);
        if (!invData) return alert('حدث خطأ في قراءة الفاتورة');

        document.body.classList.remove('printing-po');
        document.body.classList.add('printing-inv');

        document.getElementById('printInvTitle').innerText   = invData.invoice_type === 'proforma' ? 'فاتورة أولية (مطالبة مالية)' : 'فاتورة ضريبية';
        document.getElementById('printInvTypeEn').innerText  = invData.invoice_type === 'proforma' ? 'Proforma Invoice' : 'Tax Invoice';
        document.getElementById('printInvDate').innerText    = new Date(invData.created_at).toLocaleDateString('ar-EG');
        document.getElementById('printInvNum').innerText     = invData.invoice_number;
        document.getElementById('printInvClient').innerText  = document.getElementById('mgrClientName').innerText;

        const tbody = document.getElementById('printInvItemsBody');
        tbody.innerHTML = '';

        let sub = 0;
        const rawItems = invData.items_snapshot;
        const items    = typeof rawItems === 'string' ? JSON.parse(rawItems) : (rawItems || []);

        items.forEach((i, idx) => {
            const rowTotal = (i.qty || 0) * (i.price || 0);
            sub += rowTotal;

            // معالجة آمنة للاسم — حماية من البيانات القديمة
            let safeName = i.name || i.product_name || i.fullName || i.product;
            if (!safeName && i.variant_id) {
                const varDetails = getVariantDetails(i.variant_id);
                safeName = varDetails.name !== 'صنف غير معروف' ? varDetails.name : 'صنف (بيانات قديمة)';
            }
            safeName = safeName || 'صنف غير محدد';

            tbody.innerHTML += `
                <tr>
                    <td class="text-center">${idx + 1}</td>
                    <td class="font-bold">${safeName}</td>
                    <td class="text-center font-bold">${i.qty}</td>
                    <td class="text-center">${i.price}</td>
                    <td class="text-center font-bold">${rowTotal.toFixed(2)}</td>
                </tr>`;
        });

        const tax   = sub * 0.15;
        const grand = sub + tax;
        const paid  = parseFloat(invData.down_payment) || parseFloat(document.getElementById('invAdvancePayment').value) || 0;

        document.getElementById('printInvSub').innerText   = sub.toFixed(2);
        document.getElementById('printInvTax').innerText   = tax.toFixed(2);
        document.getElementById('printInvTotal').innerText = grand.toFixed(2);
        document.getElementById('printInvPaid').innerText  = paid.toFixed(2);
        document.getElementById('printInvRem').innerText   = (grand - paid).toFixed(2);

        window.print();
        setTimeout(() => document.body.classList.remove('printing-inv'), 1000);
    }

    // =====================================================================
    // الدفعات
    // =====================================================================
    function openPaymentModal() {
        document.getElementById('paymentAmount').value = '';
        document.getElementById('paymentNotes').value  = '';
        openModal('paymentModal');
    }

    async function submitClientPayment() {
        const amount  = parseFloat(document.getElementById('paymentAmount').value);
        const orderId = document.getElementById('mgrActiveOrderId').value;

        if (!amount || amount <= 0) return alert('الرجاء إدخال مبلغ صحيح.');

        const btn = document.getElementById('btnSubmitPayment');
        btn.disabled  = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const { data: orderData } = await supabaseClient
                .from('orders')
                .select('paid_amount')
                .eq('id', orderId)
                .single();

            const currentPaid = parseFloat(orderData?.paid_amount) || 0;
            const newPaid     = currentPaid + amount;

            await supabaseClient.from('orders').update({ paid_amount: newPaid }).eq('id', orderId);

            // تحديث الكاش المحلي مباشرة بدون إعادة جلب كاملة
            const idx = allOrdersList.findIndex(o => o.id === orderId);
            if (idx !== -1) allOrdersList[idx].paid_amount = newPaid;
            const aIdx = activeOrdersList.findIndex(o => o.id === orderId);
            if (aIdx !== -1) activeOrdersList[aIdx].paid_amount = newPaid;

            closeModal('paymentModal');
            filterClientOrders();
            alert('تم تسجيل الدفعة بنجاح!');
        } catch (err) {
            alert('خطأ في تسجيل الدفعة: ' + err.message);
        } finally {
            btn.disabled  = false;
            btn.innerHTML = 'تأكيد الدفعة';
        }
    }

    // =====================================================================
    // سندات التسليم
    // =====================================================================
    async function fetchDeliveriesLog(clientId) {
        const tbody = document.getElementById('mgrDeliveriesBody');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center p-3 text-gray-400"><i class="fas fa-spinner fa-spin"></i></td></tr>';

        const { data } = await supabaseClient
            .from('inventory_transactions')
            .select('*')
            .eq('client_id', clientId)
            .eq('delivery_status', 'delivered')
            .order('created_at', { ascending: false });

        tbody.innerHTML = '';
        if (data && data.length > 0) {
            data.forEach(d => {
                const varDetails = getVariantDetails(d.variant_id);
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2 text-sm">${new Date(d.created_at).toLocaleDateString('ar-EG')}</td>
                        <td class="p-2 font-bold text-green-600 font-mono">${d.quantity}</td>
                        <td class="p-2 text-sm">${varDetails.name}</td>
                    </tr>`;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-400">لا توجد تسليمات سابقة</td></tr>';
        }
    }

    async function openDeliveryModal() {
        const clientId = document.getElementById('mgrActiveClientId').value;
        const tbody    = document.getElementById('deliveryItemsBody');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> جاري البحث عن البضاعة المعلقة...</td></tr>';
        openModal('deliveryModal');

        try {
            const { data: pending } = await supabaseClient
                .from('inventory_transactions')
                .select('*')
                .eq('client_id', clientId)
                .eq('delivery_status', 'pending');

            tbody.innerHTML = '';
            if (pending && pending.length > 0) {
                pending.forEach(p => {
                    const varDetails = getVariantDetails(p.variant_id);
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-2 font-bold text-sm">${varDetails.name}</td>
                            <td class="p-2 text-center font-bold text-red-600 font-mono">${p.quantity}</td>
                            <td class="p-2 text-center bg-blue-50">
                                <input type="number" id="delQty_${p.id}" value="${p.quantity}"
                                    max="${p.quantity}" min="1"
                                    class="w-20 border rounded p-1 text-center font-bold text-blue-800">
                            </td>
                        </tr>`;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-400">لا توجد بضاعة معلقة للتسليم.</td></tr>';
            }
        } catch (err) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-500">خطأ في التحميل.</td></tr>';
        }
    }

    async function submitDelivery() {
        const inputs           = document.querySelectorAll('input[id^="delQty_"]');
        let   deliveredSomething = false;

        for (const inp of inputs) {
            const transId    = inp.id.split('_')[1];
            const deliverQty = parseInt(inp.value) || 0;
            const maxQty     = parseInt(inp.getAttribute('max')) || 0;

            if (deliverQty > 0) {
                if (deliverQty >= maxQty) {
                    await supabaseClient.from('inventory_transactions').update({ delivery_status: 'delivered' }).eq('id', transId);
                } else {
                    await supabaseClient.from('inventory_transactions').update({ delivery_status: 'delivered', quantity: deliverQty }).eq('id', transId);
                    // إنشاء سجل جديد بالكمية المتبقية
                    const { data: orig } = await supabaseClient.from('inventory_transactions').select('*').eq('id', transId).single();
                    if (orig) {
                        const newRecord = { ...orig, quantity: maxQty - deliverQty, delivery_status: 'pending' };
                        delete newRecord.id;
                        delete newRecord.created_at;
                        await supabaseClient.from('inventory_transactions').insert([newRecord]);
                    }
                }
                deliveredSomething = true;
            }
        }

        if (deliveredSomething) {
            alert('تم تسجيل التسليم بنجاح.');
            closeModal('deliveryModal');
            fetchDeliveriesLog(document.getElementById('mgrActiveClientId').value);
        } else {
            alert('يرجى إدخال كمية للتسليم.');
        }
    }

    async function closeOrderManually() {
        const orderId = document.getElementById('mgrActiveOrderId').value;
        if (!confirm('هل أنت متأكد من إنهاء الأمر وأرشفته؟')) return;

        await supabaseClient.from('orders').update({ status: 'archived' }).eq('id', orderId);
        closeModal('orderManagerModal');
        // تحديث الكاش محلياً
        allOrdersList    = allOrdersList.filter(o => o.id !== orderId);
        activeOrdersList = activeOrdersList.filter(o => o.id !== orderId);
        pendingOrdersList = pendingOrdersList.filter(o => o.id !== orderId);
        filterClientOrders();
        renderPendingOrdersTable();
    }

    // =====================================================================
    // الطباعة — أمر الإنتاج للمورد
    // =====================================================================
    async function reprintSupplierPO(poId) {
        try {
            const { data: poData } = await supabaseClient
                .from('supplier_production_orders')
                .select('*')
                .eq('id', poId)
                .single();

            const { data: poItems } = await supabaseClient
                .from('supplier_po_items')
                .select('*')
                .eq('supplier_po_id', poId);

            if (!poItems || poItems.length === 0) return alert('لا توجد بيانات للطباعة.');

            const orderItemIds = poItems.map(i => i.order_item_id);
            const { data: orderItems } = await supabaseClient
                .from('order_items')
                .select('*')
                .in('id', orderItemIds);

            const reconstructedItems = poItems.map(i => {
                const oi = (orderItems || []).find(x => x.id === i.order_item_id);
                if (!oi) return null;
                const varDetails  = getVariantDetails(oi.variant_id);
                const parentOrder = allOrdersList.find(o => o.id === oi.order_id);
                const clientName  = parentOrder ? getClientName(parentOrder.client_id) : 'عميل نقدي';

                return {
                    design_status: i.design_status,
                    notes: i.notes,
                    _meta: {
                        product: varDetails.name,
                        client:  clientName,
                        qty:     oi.quantity || 0,
                        price:   oi.unit_price || 0
                    }
                };
            }).filter(Boolean);

            buildAndPrintPO(poData, reconstructedItems, 'show', poData.supplier_id);
        } catch (err) {
            alert('خطأ في الطباعة: ' + err.message);
            console.error('reprintSupplierPO Error:', err);
        }
    }

    function buildAndPrintPO(poData, itemsWithMeta, printToggle, supplierId) {
        document.body.classList.add('printing-po');
        const printContainer = document.getElementById('printablePO');
        if (printToggle === 'hide') printContainer.classList.add('hide-price');
        else printContainer.classList.remove('hide-price');

        document.getElementById('printPoNum').innerText          = poData.po_number || '-';
        document.getElementById('printPoDate').innerText         = new Date(poData.created_at || new Date()).toLocaleDateString('ar-EG');
        document.getElementById('printPoExpectedDate').innerText = poData.expected_delivery_date || 'غير محدد';
        const suppName = suppliersList.find(s => s.id == supplierId)?.company_name || '-';
        document.getElementById('printPoSupplier').innerText = suppName;

        // تجميع الأصناف حسب المنتج
        const grouped = {};
        (itemsWithMeta || []).forEach(i => {
            const groupKey = i._meta?.product || 'غير محدد';
            if (!grouped[groupKey]) grouped[groupKey] = [];
            grouped[groupKey].push(i);
        });

        const contentDiv = document.getElementById('printPoContent');
        contentDiv.innerHTML = '';

        for (const [groupName, items] of Object.entries(grouped)) {
            contentDiv.innerHTML += `<div class="po-group-header">الصنف: ${groupName}</div>`;
            let tableHtml  = `<table class="po-table"><thead><tr>
                <th width="30%">العميل / الطلب</th>
                <th width="15%">الكمية</th>
                <th width="20%">حالة التصميم</th>
                <th width="25%">ملاحظات</th>
                <th width="10%" class="print-price-col">السعر المرجعي</th>
            </tr></thead><tbody>`;
            let totalGroupQty = 0;

            items.forEach(i => {
                totalGroupQty += i._meta.qty || 0;
                const dsText = i.design_status === 'new_design'
                    ? '<span style="color:#dc2626;font-weight:bold">تصميم جديد</span>'
                    : '<span style="color:#2563eb;font-weight:bold">إعادة طباعة</span>';
                tableHtml += `<tr>
                    <td class="font-bold">${i._meta.client || 'عميل نقدي'}</td>
                    <td class="font-bold text-lg">${(i._meta.qty || 0).toLocaleString()}</td>
                    <td>${dsText}</td>
                    <td>${i.notes || '-'}</td>
                    <td class="print-price-col" style="color:#6b7280">${i._meta.price || '-'}</td>
                </tr>`;
            });

            tableHtml += `<tr style="background:#f3f4f6;font-weight:bold">
                <td style="text-align:left">إجمالي كمية الصنف:</td>
                <td colspan="4" style="color:#3e206d;font-size:1.1em">${totalGroupQty.toLocaleString()}</td>
            </tr></tbody></table>`;
            contentDiv.innerHTML += tableHtml;
        }

        window.print();
        setTimeout(() => document.body.classList.remove('printing-po'), 1000);
    }

    // =====================================================================
    // المودال — open / close
    // =====================================================================
    function openModal(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('opacity-0', 'pointer-events-none');
        const container = el.querySelector('.modal-container');
        if (container) { container.classList.remove('scale-95'); container.classList.add('scale-100'); }
    }

    function closeModal(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const container = el.querySelector('.modal-container');
        if (container) { container.classList.add('scale-95'); container.classList.remove('scale-100'); }
        setTimeout(() => el.classList.add('opacity-0', 'pointer-events-none'), 200);
    }

</script>
</body>
</html>
