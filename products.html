<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.PACK - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .gpack-purple { background-color: #3e206d; }
        .gpack-yellow { color: #fccf4d; }
        .gpack-btn { background-color: #fccf4d; color: #3e206d; transition: all 0.3s; }
        .gpack-btn:hover { background-color: #e6bd45; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar-item:hover { background-color: rgba(255,255,255,0.1); border-right: 4px solid #fccf4d; }
        .sidebar-item.active { background-color: rgba(255,255,255,0.15); border-right: 4px solid #fccf4d; color: #fff; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
        .tab-btn { border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; }
        .tab-btn:hover { color: #3e206d; }
        .tab-btn.active { border-bottom-color: #3e206d; color: #3e206d; font-weight: bold; background-color: #f3f4f6; }
        .hidden-row { display: none; }
        .rotate-180 { transform: rotate(180deg); transition: transform 0.3s; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 gpack-purple text-white flex flex-col shadow-2xl z-20 hidden md:flex">
        <div class="h-20 flex items-center justify-center border-b border-purple-800/50">
            <h1 class="text-2xl font-bold tracking-wider flex items-center gap-2">
                <i class="fas fa-box-open gpack-yellow"></i>
                <span>G.PACK</span>
            </h1>
        </div>
        <div class="p-6 flex items-center gap-3 border-b border-purple-800/50 bg-purple-900/20">
            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center border border-yellow-400">
                <i class="fas fa-user text-yellow-400"></i>
            </div>
            <div>
                <p class="text-sm font-bold">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</p>
                <p class="text-xs text-gray-300">Admin</p>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <a href="index.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-th-large w-5"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="products.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-box w-5"></i> Ø§Ù„Ø£ØµÙ†Ø§Ù</a>
            <a href="quotations.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-file-invoice-dollar w-5"></i> Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</a>
            <a href="production_orders.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-industry w-5"></i> Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„</a>
            <a href="inventory.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-cubes w-5"></i> Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</a>
            <a href="suppliers.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-truck w-5"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</a>
            <a href="clients.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-users w-5"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a>
            <a href="employees.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-id-card w-5"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a>
            <a href="lists.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-list-alt w-5"></i> Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</a>
            <a href="permissions.html" class="sidebar-item active flex items-center gap-3 px-6 py-3 text-white font-medium whitespace-nowrap"><i class="fas fa-user-shield w-5"></i> Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</a>
            <a href="tasks.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-tasks w-5"></i> Ø§Ù„Ù…Ù‡Ø§Ù…</a>
            <a href="terms.html" class="sidebar-item flex items-center gap-3 px-6 py-3 text-gray-300 hover:text-white whitespace-nowrap"><i class="fas fa-file-signature w-5"></i> Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø©</a>
        </nav>
        <div class="p-4 border-t border-purple-800/50">
            <button class="w-full flex items-center justify-center gap-2 text-red-300 hover:text-red-100 transition-colors py-2">
                <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="h-20 bg-white shadow-sm flex items-center justify-between px-8 z-10">
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª</h2>
                <div class="flex bg-white border border-gray-200 rounded-lg p-1 mr-6 shadow-sm">
                    <button onclick="switchTab('products')" id="btn-products" class="tab-btn active px-6 py-2 rounded-md text-sm transition-all">Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
                    <button onclick="switchTab('categories')" id="btn-categories" class="tab-btn px-6 py-2 rounded-md text-sm transition-all">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</button>
                    <button onclick="switchTab('units')" id="btn-units" class="tab-btn px-6 py-2 rounded-md text-sm transition-all">Ø§Ù„ÙˆØ­Ø¯Ø§Øª</button>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="openActionModal()" class="gpack-btn px-4 py-2 rounded-lg font-bold text-sm shadow-md flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    <span id="mainActionBtnText">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div id="tab-products" class="tab-content block">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex gap-4">
                        <input type="text" id="prodSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." class="p-2 border rounded-lg text-sm w-64 focus:outline-none focus:border-purple-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-white text-gray-500 text-xs uppercase border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-4 w-10"></th>
                                    <th class="px-6 py-4 font-medium">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                                    <th class="px-6 py-4 font-medium">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                    <th class="px-6 py-4 font-medium">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th class="px-6 py-4 font-medium">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</th>
                                    <th class="px-6 py-4 font-medium">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody" class="divide-y divide-gray-100 text-sm bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-categories" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 max-w-2xl mx-auto mt-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
                    <ul id="categoriesList" class="divide-y divide-gray-100 border rounded-lg"></ul>
                </div>
            </div>

            <div id="tab-units" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 max-w-2xl mx-auto mt-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
                    <ul id="unitsList" class="divide-y divide-gray-100 border rounded-lg"></ul>
                </div>
            </div>
        </div>
    </main>

    <div id="productModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded-2xl shadow-lg z-50 overflow-y-auto transform transition-all scale-95" style="max-height: 90vh;">
            <div class="modal-content py-4 text-right px-6">
                <div class="flex justify-between items-center pb-3 border-b border-gray-100 mb-4">
                    <p class="text-xl font-bold text-purple-800" id="productModalTitle">ØªØ¹Ø±ÙŠÙ ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</p>
                    <div class="modal-close cursor-pointer" onclick="toggleModal('productModal')">
                        <i class="fas fa-times text-gray-500"></i>
                    </div>
                </div>
                <form id="smartProductForm" class="space-y-6">
                    <input type="hidden" id="pId"> 
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-1">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù (Ø§Ù„Ø£Ø¨)</label>
                                <input type="text" id="pName" class="w-full bg-white border border-gray-200 rounded-lg py-2 px-3 focus:border-purple-500 outline-none" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙƒÙˆØ§Ø¨ ÙˆØ±Ù‚ÙŠØ©" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-1">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                                <select id="pCategorySelect" class="w-full bg-white border border-gray-200 rounded-lg py-2 px-3 outline-none" required></select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-1">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                <select id="pUnitSelect" class="w-full bg-white border border-gray-200 rounded-lg py-2 px-3 outline-none" required></select>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-gray-800 font-bold text-sm">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Variants)</h4>
                            <button type="button" onclick="addVariantRow()" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold hover:bg-green-200 transition">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ø³</button>
                        </div>
                        <table class="w-full text-right text-sm">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="p-2 w-1/4">Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§Ø³</th>
                                    <th class="p-2">ØªÙƒÙ„ÙØ© Ø§Ù„ØªØµÙ†ÙŠØ¹</th>
                                    <th class="p-2">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                    <th class="p-2 text-center">ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŸ</th>
                                    <th class="p-2 w-20">Ø­Ø¯ Ø§Ù„Ø·Ù„Ø¨</th>
                                    <th class="p-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="variantsContainer"></tbody>
                        </table>
                        <p class="text-xs text-gray-400 mt-2">* ÙØ¹Ù‘Ù„ "ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†" ÙÙ‚Ø· Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ø§ØªÙØ§Ù‚ÙŠØ§Øª ØªØ®Ø²ÙŠÙ†.</p>
                    </div>
                    <div class="pt-4 flex items-center justify-end gap-3 border-t border-gray-100">
                        <button type="button" onclick="toggleModal('productModal')" class="bg-gray-100 text-gray-700 py-2 px-6 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" id="mainSaveBtn" class="gpack-btn py-2 px-8 rounded-lg font-bold shadow-md flex items-center gap-2"><span>Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span><i class="fas fa-check"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="tiersModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-2xl shadow-lg z-50 overflow-y-auto transform transition-all scale-95">
            <div class="modal-content py-4 text-right px-6">
                <div class="flex justify-between items-center pb-3 border-b border-gray-100 mb-4">
                    <div>
                        <p class="text-xl font-bold text-purple-800">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Ù„Ù„ÙƒÙ…ÙŠØ§Øª)</p>
                        <p class="text-xs text-gray-500 mt-1" id="tierVariantName">...</p>
                    </div>
                    <div class="modal-close cursor-pointer" onclick="toggleModal('tiersModal')">
                        <i class="fas fa-times text-gray-500"></i>
                    </div>
                </div>
                <input type="hidden" id="currentVariantId">
                <div class="overflow-x-auto">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-purple-50 text-purple-800">
                            <tr>
                                <th class="p-3">Ù…Ù† ÙƒÙ…ÙŠØ©</th>
                                <th class="p-3">Ø¥Ù„Ù‰ ÙƒÙ…ÙŠØ©</th>
                                <th class="p-3">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                <th class="p-3">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                <th class="p-3"></th>
                            </tr>
                        </thead>
                        <tbody id="tiersContainer"></tbody>
                    </table>
                </div>
                <button onclick="addTierRow()" class="mt-3 text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full font-bold hover:bg-purple-200 transition">+ Ø´Ø±ÙŠØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                <div class="pt-4 flex items-center justify-end gap-3 border-t border-gray-100 mt-4">
                    <button onclick="toggleModal('tiersModal')" class="bg-gray-100 text-gray-700 py-2 px-6 rounded-lg font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button onclick="saveTiers()" class="gpack-btn py-2 px-8 rounded-lg font-bold shadow-md">Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­</button>
                </div>
            </div>
        </div>
    </div>

    <div id="simpleModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-lg z-50 overflow-y-auto transform transition-all scale-95">
            <div class="modal-content py-4 text-right px-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800" id="simpleModalTitle">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</h3>
                <input type="hidden" id="simpleId">
                <input type="text" id="simpleInput" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:border-purple-500 outline-none" placeholder="Ø§Ù„Ø§Ø³Ù…...">
                <div class="flex gap-2">
                    <button onclick="saveSimpleItem()" class="flex-1 gpack-btn py-2 rounded-lg font-bold">Ø­ÙØ¸</button>
                    <button onclick="toggleModal('simpleModal')" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ipomgnqpmbdzvmmjactv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwb21nbnFwbWJkenZtbWphY3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNjk3NDUsImV4cCI6MjA4Njc0NTc0NX0.99dmOGTc0AmsBGGYV0eM3kKSpbYdb6f-0X2mYLnGPtA';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentTab = 'products';

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`btn-${tabName}`).classList.add('active');
            const btnText = document.getElementById('mainActionBtnText');
            if(tabName === 'products') {
                btnText.innerText = 'Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯';
                fetchProducts();
            } else if (tabName === 'categories') {
                btnText.innerText = 'Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ';
                fetchCategories();
            } else {
                btnText.innerText = 'Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø©';
                fetchUnits();
            }
        }

        function openActionModal() {
            if(currentTab === 'products') {
                document.getElementById('productModalTitle').innerText = 'ØªØ¹Ø±ÙŠÙ ØµÙ†Ù Ø¬Ø¯ÙŠØ¯';
                document.getElementById('pId').value = ''; 
                loadDropdowns();
                document.getElementById('smartProductForm').reset();
                document.getElementById('variantsContainer').innerHTML = '';
                addVariantRow();
                toggleModal('productModal');
            } else {
                document.getElementById('simpleId').value = '';
                document.getElementById('simpleInput').value = '';
                document.getElementById('simpleModalTitle').innerText = currentTab === 'categories' ? 'Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ Ø¬Ø¯ÙŠØ¯' : 'Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ù‚ÙŠØ§Ø³';
                toggleModal('simpleModal');
            }
        }

        async function fetchProducts() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            const { data: products, error } = await supabaseClient.from('products').select(`*, categories(name), units(name)`).order('created_at', { ascending: false });
            
            if(error) { tbody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 py-4">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}</td></tr>`; return; }

            tbody.innerHTML = '';
            if(!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§ÙØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.</td></tr>';
                return;
            }
            for(const p of products) {
                const { count } = await supabaseClient.from('product_variants').select('*', { count: 'exact', head: true }).eq('product_id', p.id);
                const row = `
                    <tr class="hover:bg-gray-50 border-b border-gray-100 group">
                        <td class="px-4 py-4 text-center"><button onclick="toggleVariants('${p.id}')" class="text-purple-600 bg-purple-50 w-6 h-6 rounded-full flex items-center justify-center hover:bg-purple-100 transition"><i id="icon-${p.id}" class="fas fa-chevron-down text-xs transition-transform duration-300"></i></button></td>
                        <td class="px-6 py-4 font-bold text-gray-800">${p.name}</td>
                        <td class="px-6 py-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">${p.categories?.name || '-'}</span></td>
                        <td class="px-6 py-4 text-gray-600">${p.units?.name || '-'}</td>
                        <td class="px-6 py-4 text-gray-600"><span class="bg-blue-50 text-blue-600 px-2 rounded text-xs font-bold">${count || 0} Ù…Ù‚Ø§Ø³Ø§Øª</span></td>
                        <td class="px-6 py-4 flex gap-2 justify-end"><button onclick="editProduct('${p.id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="deleteParentProduct('${p.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                    </tr>
                    <tr id="variants-${p.id}" class="hidden-row bg-gray-50"><td colspan="6" class="p-4 pr-12"><table class="w-full text-xs text-right bg-white rounded-lg border border-gray-200 overflow-hidden"><thead class="bg-gray-100 text-gray-600"><tr><th class="p-2">Ø§Ù„Ù…Ù‚Ø§Ø³</th><th class="p-2">Ø§Ù„ØªÙƒÙ„ÙØ©</th><th class="p-2">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th class="p-2">ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th class="p-2">Ø§Ù„Ø´Ø±Ø§Ø¦Ø­</th></tr></thead><tbody id="body-${p.id}"></tbody></table></td></tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            }
        }

        async function toggleVariants(prodId) {
            const row = document.getElementById(`variants-${prodId}`);
            const icon = document.getElementById(`icon-${prodId}`);
            const tbody = document.getElementById(`body-${prodId}`);
            if (row.classList.contains('hidden-row')) {
                row.classList.remove('hidden-row');
                icon.classList.add('rotate-180');
                const { data: variants } = await supabaseClient.from('product_variants').select('*').eq('product_id', prodId);
                tbody.innerHTML = '';
                if(variants && variants.length > 0) {
                    variants.forEach(v => {
                        const stockStatus = v.track_stock ? `<span class="text-green-600 font-bold">Ù…ÙØ¹Ù„ (${v.min_stock_level})</span>` : '<span class="text-gray-400">ØºÙŠØ± Ù…ÙØ¹Ù„</span>';
                        tbody.innerHTML += `<tr class="border-b last:border-none"><td class="p-2 font-bold text-gray-700">${v.size_name}</td><td class="p-2 text-gray-500">${v.cost_price} Ø±.Ø³</td><td class="p-2 text-green-600 font-bold">${v.selling_price} Ø±.Ø³</td><td class="p-2">${stockStatus}</td><td class="p-2"><button onclick="openTiersModal('${v.id}', '${v.size_name}')" class="bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-200 hover:bg-purple-100 flex items-center gap-1"><i class="fas fa-tags"></i> Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button></td></tr>`;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-2 text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø³Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                }
            } else {
                row.classList.add('hidden-row');
                icon.classList.remove('rotate-180');
            }
        }

        function addVariantRow(data = null) {
            const container = document.getElementById('variantsContainer');
            const rowId = Date.now() + Math.random().toString(16).slice(2);
            const sizeVal = data ? data.size_name : '';
            const costVal = data ? data.cost_price : '';
            const sellVal = data ? data.selling_price : '';
            const isTracked = data ? (data.track_stock ? 'checked' : '') : '';
            const minStockVal = data ? data.min_stock_level : '10';
            const disabledState = isTracked ? '' : 'disabled style="background-color: #f3f4f6;"';
            const row = `<tr id="row-${rowId}" class="border-b border-gray-50"><td class="p-2"><input type="text" name="size_name[]" value="${sizeVal}" class="w-full border rounded px-2 py-1 focus:border-purple-500 outline-none text-xs" required></td><td class="p-2"><input type="number" step="0.01" name="cost_price[]" value="${costVal}" class="w-full border rounded px-2 py-1 focus:border-purple-500 outline-none text-xs"></td><td class="p-2"><input type="number" step="0.01" name="selling_price[]" value="${sellVal}" class="w-full border rounded px-2 py-1 focus:border-purple-500 outline-none text-xs" required></td><td class="p-2 text-center"><input type="checkbox" class="stock-check" onchange="toggleMinStock(this)" ${isTracked}></td><td class="p-2"><input type="number" name="min_stock[]" value="${minStockVal}" class="min-stock-input w-full border rounded px-2 py-1 focus:border-purple-500 outline-none text-xs" ${disabledState}></td><td class="p-2 text-center"><button type="button" onclick="document.getElementById('row-${rowId}').remove()" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></td></tr>`;
            container.insertAdjacentHTML('beforeend', row);
        }

        function toggleMinStock(checkbox) {
            const row = checkbox.closest('tr');
            const input = row.querySelector('.min-stock-input');
            if(checkbox.checked) { input.disabled = false; input.style.backgroundColor = 'white'; } else { input.disabled = true; input.style.backgroundColor = '#f3f4f6'; }
        }

        document.getElementById('smartProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('mainSaveBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            btn.disabled = true;
            
            const pId = document.getElementById('pId').value;
            const pName = document.getElementById('pName').value;
            const pCat = document.getElementById('pCategorySelect').value;
            const pUnit = document.getElementById('pUnitSelect').value;

            try {
                // 1. Save Parent
                let prodData;
                const parentPayload = { name: pName, category_id: pCat, unit_id: pUnit };
                
                if (pId) {
                    const { data, error } = await supabaseClient.from('products').update(parentPayload).eq('id', pId).select().single();
                    if(error) throw new Error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: " + error.message);
                    prodData = data;
                } else {
                    const { data, error } = await supabaseClient.from('products').insert([parentPayload]).select().single();
                    if(error) throw new Error("ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: " + error.message);
                    prodData = data;
                }

                // 2. Save Variants
                if (pId) await supabaseClient.from('product_variants').delete().eq('product_id', pId);

                const sizes = document.getElementsByName('size_name[]');
                const costs = document.getElementsByName('cost_price[]');
                const sells = document.getElementsByName('selling_price[]');
                const mins = document.getElementsByName('min_stock[]');
                const checks = document.querySelectorAll('.stock-check');

                const variants = [];
                for(let i=0; i<sizes.length; i++) {
                    variants.push({
                        product_id: prodData.id,
                        size_name: sizes[i].value,
                        cost_price: costs[i].value || 0,
                        selling_price: sells[i].value || 0,
                        track_stock: checks[i].checked,
                        min_stock_level: checks[i].checked ? (mins[i].value || 10) : null,
                        stock_quantity: 0
                    });
                }

                if(variants.length > 0) {
                    const { error } = await supabaseClient.from('product_variants').insert(variants);
                    if(error) throw new Error("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª: " + error.message);
                }

                toggleModal('productModal');
                fetchProducts();
                alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");

            } catch (err) {
                alert("ğŸ”´ Ø®Ø·Ø£: " + err.message);
                console.error(err);
            } finally {
                btn.innerHTML = '<span>Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span><i class="fas fa-check"></i>';
                btn.disabled = false;
            }
        });

        // --- Tiers ---
        async function openTiersModal(variantId, variantName) {
            document.getElementById('currentVariantId').value = variantId;
            document.getElementById('tierVariantName').innerText = `Ù„Ù„Ù…Ù‚Ø§Ø³: ${variantName}`;
            document.getElementById('tiersContainer').innerHTML = ''; 
            const { data: tiers } = await supabaseClient.from('product_pricing_tiers').select('*').eq('variant_id', variantId).order('min_quantity');
            if(tiers && tiers.length > 0) { tiers.forEach(tier => addTierRow(tier)); } else { addTierRow(); }
            toggleModal('tiersModal');
        }

        function addTierRow(data = null) {
            const container = document.getElementById('tiersContainer');
            const rowId = Date.now() + Math.random().toString(16).slice(2);
            const min = data ? data.min_quantity : '';
            const max = data ? data.max_quantity : '';
            const cost = data ? data.cost_price : '';
            const sell = data ? data.selling_price : '';
            const row = `<tr id="tier-${rowId}" class="border-b border-gray-50"><td class="p-2"><input type="number" name="t_min[]" value="${min}" class="w-full border rounded p-1 text-xs" placeholder="1"></td><td class="p-2"><input type="number" name="t_max[]" value="${max}" class="w-full border rounded p-1 text-xs" placeholder="Ù…Ø«Ù„Ø§Ù‹ 1000"></td><td class="p-2"><input type="number" step="0.01" name="t_cost[]" value="${cost}" class="w-full border rounded p-1 text-xs" placeholder="0.00"></td><td class="p-2"><input type="number" step="0.01" name="t_sell[]" value="${sell}" class="w-full border rounded p-1 text-xs" placeholder="0.00"></td><td class="p-2"><button onclick="document.getElementById('tier-${rowId}').remove()" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></td></tr>`;
            container.insertAdjacentHTML('beforeend', row);
        }

        async function saveTiers() {
            const variantId = document.getElementById('currentVariantId').value;
            const mins = document.getElementsByName('t_min[]');
            const maxs = document.getElementsByName('t_max[]');
            const costs = document.getElementsByName('t_cost[]');
            const sells = document.getElementsByName('t_sell[]');
            const tiersData = [];
            for(let i=0; i<mins.length; i++) {
                if(mins[i].value && sells[i].value) {
                    tiersData.push({ variant_id: variantId, min_quantity: mins[i].value, max_quantity: maxs[i].value || null, cost_price: costs[i].value, selling_price: sells[i].value });
                }
            }
            await supabaseClient.from('product_pricing_tiers').delete().eq('variant_id', variantId);
            if(tiersData.length > 0) { const { error } = await supabaseClient.from('product_pricing_tiers').insert(tiersData); if(error) { alert('Ø®Ø·Ø£: ' + error.message); return; } }
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ø¨Ù†Ø¬Ø§Ø­');
            toggleModal('tiersModal');
        }

        async function editProduct(prodId) {
            document.getElementById('productModalTitle').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù';
            document.getElementById('pId').value = prodId; 
            await loadDropdowns();
            const { data: prod } = await supabaseClient.from('products').select('*').eq('id', prodId).single();
            if(prod) { document.getElementById('pName').value = prod.name; document.getElementById('pCategorySelect').value = prod.category_id; document.getElementById('pUnitSelect').value = prod.unit_id; }
            const { data: variants } = await supabaseClient.from('product_variants').select('*').eq('product_id', prodId);
            document.getElementById('variantsContainer').innerHTML = '';
            if(variants && variants.length > 0) { variants.forEach(v => addVariantRow(v)); } else { addVariantRow(); }
            toggleModal('productModal');
        }

        async function fetchCategories() {
            const { data } = await supabaseClient.from('categories').select('*').order('created_at');
            const list = document.getElementById('categoriesList');
            list.innerHTML = '';
            if(data) data.forEach(c => { list.innerHTML += `<li class="p-3 flex justify-between bg-gray-50 mb-1 rounded items-center"><span>${c.name}</span><div class="flex gap-2"><button onclick="editSimpleItem('categories', '${c.id}', '${c.name}')" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteItem('categories', '${c.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></div></li>`; });
        }

        async function fetchUnits() {
            const { data } = await supabaseClient.from('units').select('*').order('created_at');
            const list = document.getElementById('unitsList');
            list.innerHTML = '';
            if(data) data.forEach(u => { list.innerHTML += `<li class="p-3 flex justify-between bg-gray-50 mb-1 rounded items-center"><span>${u.name}</span><div class="flex gap-2"><button onclick="editSimpleItem('units', '${u.id}', '${u.name}')" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteItem('units', '${u.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></div></li>`; });
        }

        function editSimpleItem(type, id, name) {
            document.getElementById('simpleId').value = id;
            document.getElementById('simpleInput').value = name;
            document.getElementById('simpleModalTitle').innerText = type === 'categories' ? 'ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ†ÙŠÙ' : 'ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø¯Ø©';
            toggleModal('simpleModal');
        }

        async function saveSimpleItem() {
            const id = document.getElementById('simpleId').value;
            const name = document.getElementById('simpleInput').value;
            if(!name) return;
            const table = currentTab === 'categories' ? 'categories' : 'units';
            if(id) await supabaseClient.from(table).update({ name }).eq('id', id); else await supabaseClient.from(table).insert([{ name }]);
            toggleModal('simpleModal');
            currentTab === 'categories' ? fetchCategories() : fetchUnits();
        }

        async function deleteItem(table, id) {
            if(confirm('Ø­Ø°ÙØŸ')) { await supabaseClient.from(table).delete().eq('id', id); table === 'categories' ? fetchCategories() : fetchUnits(); }
        }

        async function deleteParentProduct(id) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ')) { await supabaseClient.from('products').delete().eq('id', id); fetchProducts(); }
        }

        async function loadDropdowns() {
            const { data: cats } = await supabaseClient.from('categories').select('*');
            const catSelect = document.getElementById('pCategorySelect');
            catSelect.innerHTML = '<option value="">Ø§Ø®ØªØ±..</option>';
            if(cats) cats.forEach(c => catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            const { data: units } = await supabaseClient.from('units').select('*');
            const unitSelect = document.getElementById('pUnitSelect');
            unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ±..</option>';
            if(units) units.forEach(u => unitSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`);
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('opacity-0');
            el.classList.toggle('pointer-events-none');
            const content = el.querySelector('.modal-container');
            content.classList.toggle('scale-95');
            content.classList.toggle('scale-100');
        }

        fetchProducts();
    </script>
</body>
</html>
